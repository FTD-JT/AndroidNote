<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>ListView | Android常用学习资源</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="1.3.1" data-basepath=".." data-revision="1436495550272">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> UI</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" >
            
            <span><b>1.1.</b> Layouts</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" >
            
            <span><b>1.2.</b> Components</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.2.1" data-path="ui/textview.html">
            
                
                    <a href="../ui/textview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.1.</b>
                        
                         TextView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.2" data-path="ui/webview.html">
            
                
                    <a href="../ui/webview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.2.</b>
                        
                         WebView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.3" data-path="ui/recyclerview.html">
            
                
                    <a href="../ui/recyclerview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.3.</b>
                        
                         RecyclerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.4" data-path="ui/fragmenttabhost.html">
            
                
                    <a href="../ui/fragmenttabhost.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.4.</b>
                        
                         FragmentTabHost
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.5" data-path="ui/viewpager.html">
            
                
                    <a href="../ui/viewpager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.5.</b>
                        
                         ViewPager
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.3" >
            
            <span><b>1.3.</b> AdapterView</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter active" data-level="1.3.1" data-path="ui/listview.html">
            
                
                    <a href="../ui/listview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.1.</b>
                        
                         ListView
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.4" >
            
            <span><b>1.4.</b> Adapter</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="ui/actionbar.html">
            
                
                    <a href="../ui/actionbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         ActionBar
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="ui/toast.html">
            
                
                    <a href="../ui/toast.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         Toast
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="ui/notification.html">
            
                
                    <a href="../ui/notification.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         Notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="ui/layoutinflater.html">
            
                
                    <a href="../ui/layoutinflater.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         LayoutInflater
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.9" data-path="ui/customview.html">
            
                
                    <a href="../ui/customview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         自定义View
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" >
            
            <span><b>1.10.</b> Resource</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.10.1" data-path="ui/drawable-resource.html">
            
                
                    <a href="../ui/drawable-resource.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.1.</b>
                        
                         DrawableResource
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Intent</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Activity</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="activity/Activity启动模式.html">
            
                
                    <a href="../activity/Activity启动模式.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Activity启动模式
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="activity/页面切换之间的数据传递.html">
            
                
                    <a href="../activity/页面切换之间的数据传递.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         数据传递
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" >
            
            <span><b>4.</b> Fragment</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="fragment/manager.html">
            
                
                    <a href="../fragment/manager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Fragment管理
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" >
            
            <span><b>5.</b> Service</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="get_androidmanifest_info.html">
            
                
                    <a href="../get_androidmanifest_info.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         获取AndroidManifest.xml信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" >
            
            <span><b>7.</b> [多线程]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="7.1" data-path="multithread/handler.html">
            
                
                    <a href="../multithread/handler.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                         Handler
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="8" >
            
            <span><b>8.</b> [存储]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="8.1" data-path="data/sharedpreferences.html">
            
                
                    <a href="../data/sharedpreferences.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.</b>
                        
                         SharedPreferences
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8.2" >
            
            <span><b>8.2.</b> [数据库]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="8.2.1" data-path="data/sqlite.html">
            
                
                    <a href="../data/sqlite.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.2.1.</b>
                        
                         SQLite使用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8.2.2" data-path="data/activeandroid.html">
            
                
                    <a href="../data/activeandroid.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.2.2.</b>
                        
                         ActiveAndroid
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="RxJava.html">
            
                
                    <a href="../RxJava.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         RxJava
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="MVVM.html">
            
                
                    <a href="../MVVM.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         MVVM
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="parse/gson.html">
            
                
                    <a href="../parse/gson.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         JSON解析
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" >
            
            <span><b>12.</b> 网络请求</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="12.1" data-path="net/httpurlconnection.html">
            
                
                    <a href="../net/httpurlconnection.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.1.</b>
                        
                         HttpURLConnection使用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12.2" data-path="net/okhttp.html">
            
                
                    <a href="../net/okhttp.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.2.</b>
                        
                         OkHttp
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12.3" data-path="net/retrofit.html">
            
                
                    <a href="../net/retrofit.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.3.</b>
                        
                         Retrofit
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12.4" data-path="net/volley.html">
            
                
                    <a href="../net/volley.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.4.</b>
                        
                         Volley
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="13" >
            
            <span><b>13.</b> 网络图片加载</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="13.1" data-path="net/android-universal-image-loader.html">
            
                
                    <a href="../net/android-universal-image-loader.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.1.</b>
                        
                         Android-Universal-Image-Loader
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.2" data-path="net/picasso.html">
            
                
                    <a href="../net/picasso.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.2.</b>
                        
                         Picasso
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="net/downloadprovider.html">
            
                
                    <a href="../net/downloadprovider.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         DownloadProvider
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" >
            
            <span><b>15.</b> 注解</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="15.1" data-path="annotation/butterknife.html">
            
                
                    <a href="../annotation/butterknife.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.1.</b>
                        
                         ButterKnife
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15.2" data-path="annotation/androidannotations.html">
            
                
                    <a href="../annotation/androidannotations.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.2.</b>
                        
                         AndroidAnnotations
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="16" >
            
            <span><b>16.</b> 工具</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="16.1" >
            
            <span><b>16.1.</b> AndroidStudio</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="16.1.1" data-path="tools/android-studio/tips_and_tricks.html">
            
                
                    <a href="../tools/android-studio/tips_and_tricks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.1.1.</b>
                        
                         提示和技巧
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16.1.2" data-path="tools/android-studio/question.html">
            
                
                    <a href="../tools/android-studio/question.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.1.2.</b>
                        
                         常见问题
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="16.2" data-path="tools/android-resource-remover.html">
            
                
                    <a href="../tools/android-resource-remover.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.2.</b>
                        
                         android-resource-remover
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Android常用学习资源</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_1153">
                    
                        <h2 id="listview">ListView</h2>
<h3>1.ListView源码分析</h3>


<h4 id="1.1SetAdapter过程分析">1.1SetAdapter过程分析</h4>

<pre><code class="lang-java">
    <span class="hljs-javadoc">/**
     * Sets the data behind this ListView.
     *
     * The adapter passed to this method may be wrapped by a {@link WrapperListAdapter},
     * depending on the ListView features currently in use. For instance, adding
     * headers and/or footers will cause the adapter to be wrapped.
     *
     *<span class="hljs-javadoctag"> @param</span> adapter The ListAdapter which is responsible for maintaining the
     *        data backing this list and for producing a view to represent an
     *        item in that data set.
     *
     *<span class="hljs-javadoctag"> @see</span> #getAdapter()
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAdapter</span><span class="hljs-params">(ListAdapter adapter)</span> </span>{
        <span class="hljs-keyword">if</span> (mAdapter != <span class="hljs-keyword">null</span> &amp;&amp; mDataSetObserver != <span class="hljs-keyword">null</span>) {
            mAdapter.unregisterDataSetObserver(mDataSetObserver);
        }
        resetList();
        mRecycler.clear();

        <span class="hljs-keyword">if</span> (mHeaderViewInfos.size() &gt; <span class="hljs-number">0</span>|| mFooterViewInfos.size() &gt; <span class="hljs-number">0</span>) {
            mAdapter = <span class="hljs-keyword">new</span> HeaderViewListAdapter(mHeaderViewInfos, mFooterViewInfos, adapter);
        } <span class="hljs-keyword">else</span> {
            mAdapter = adapter;
        }

        mOldSelectedPosition = INVALID_POSITION;
        mOldSelectedRowId = INVALID_ROW_ID;
        <span class="hljs-comment">// 调用父类的setAdapter方法</span>
        <span class="hljs-keyword">super</span>.setAdapter(adapter);

        <span class="hljs-keyword">if</span> (mAdapter != <span class="hljs-keyword">null</span>) {
            mAreAllItemsSelectable = mAdapter.areAllItemsEnabled();
            mOldItemCount = mItemCount;
            mItemCount = mAdapter.getCount();
            checkFocus();
            <span class="hljs-comment">// 创建DataSetObserver</span>
            mDataSetObserver = <span class="hljs-keyword">new</span> AdapterDataSetObserver();
            mAdapter.registerDataSetObserver(mDataSetObserver);

            mRecycler.setViewTypeCount(mAdapter.getViewTypeCount());

            <span class="hljs-keyword">int</span> position;
            <span class="hljs-keyword">if</span> (mStackFromBottom) {
                position = lookForSelectablePosition(mItemCount - <span class="hljs-number">1</span>, <span class="hljs-keyword">false</span>);
            } <span class="hljs-keyword">else</span> {
                position = lookForSelectablePosition(<span class="hljs-number">0</span>, <span class="hljs-keyword">true</span>);
            }
            setSelectedPositionInt(position);
            setNextSelectedPositionInt(position);

            <span class="hljs-keyword">if</span> (mItemCount == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// Nothing selected</span>
                checkSelectionChanged();
            }
        } <span class="hljs-keyword">else</span> {
            mAreAllItemsSelectable = <span class="hljs-keyword">true</span>;
            checkFocus();
            <span class="hljs-comment">// Nothing selected</span>
            checkSelectionChanged();
        }

        requestLayout();
    }
</code></pre>
<p><code>AbsListView</code>的内部类<code>RecycleBin</code>用于辅助ListView复用View。</p>
<pre><code class="lang-java"><span class="hljs-javadoc">/**
     * The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of
     * storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the
     * start of a layout. By construction, they are displaying current information. At the end of
     * layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that
     * could potentially be used by the adapter to avoid allocating views unnecessarily.
     *
     *<span class="hljs-javadoctag"> @see</span> android.widget.AbsListView#setRecyclerListener(android.widget.AbsListView.RecyclerListener)
     *<span class="hljs-javadoctag"> @see</span> android.widget.AbsListView.RecyclerListener
     */</span>
 <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RecycleBin</span> </span>{
        <span class="hljs-keyword">private</span> RecyclerListener mRecyclerListener;

        <span class="hljs-javadoc">/**
         * The position of the first view stored in mActiveViews.
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mFirstActivePosition;

        <span class="hljs-javadoc">/**
         * Views that were on screen at the start of layout. This array is populated at the start of
         * layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.
         * Views in mActiveViews represent a contiguous range of Views, with position of the first
         * view store in mFirstActivePosition.
         */</span>
        <span class="hljs-keyword">private</span> View[] mActiveViews = <span class="hljs-keyword">new</span> View[<span class="hljs-number">0</span>];

        <span class="hljs-javadoc">/**
         * Unsorted views that can be used by the adapter as a convert view.
         */</span>
        <span class="hljs-keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mViewTypeCount;

        <span class="hljs-keyword">private</span> ArrayList&lt;View&gt; mCurrentScrap;

        <span class="hljs-keyword">private</span> ArrayList&lt;View&gt; mSkippedScrap;

        <span class="hljs-keyword">private</span> SparseArray&lt;View&gt; mTransientStateViews;
        <span class="hljs-keyword">private</span> LongSparseArray&lt;View&gt; mTransientStateViewsById;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setViewTypeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> viewTypeCount)</span> </span>{
            <span class="hljs-keyword">if</span> (viewTypeCount &lt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Can't have a viewTypeCount &lt; 1"</span>);
            }
            <span class="hljs-comment">//noinspection unchecked</span>
            ArrayList&lt;View&gt;[] scrapViews = <span class="hljs-keyword">new</span> ArrayList[viewTypeCount];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; viewTypeCount; i++) {
                scrapViews[i] = <span class="hljs-keyword">new</span> ArrayList&lt;View&gt;();
            }
            mViewTypeCount = viewTypeCount;
            mCurrentScrap = scrapViews[<span class="hljs-number">0</span>];
            mScrapViews = scrapViews;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">markChildrenDirty</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> scrapCount = scrap.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; scrapCount; i++) {
                    scrap.get(i).forceLayout();
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> typeCount = mViewTypeCount;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; typeCount; i++) {
                    <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];
                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> scrapCount = scrap.size();
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; scrapCount; j++) {
                        scrap.get(j).forceLayout();
                    }
                }
            }
            <span class="hljs-keyword">if</span> (mTransientStateViews != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = mTransientStateViews.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
                    mTransientStateViews.valueAt(i).forceLayout();
                }
            }
            <span class="hljs-keyword">if</span> (mTransientStateViewsById != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = mTransientStateViewsById.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
                    mTransientStateViewsById.valueAt(i).forceLayout();
                }
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldRecycleViewType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> viewType)</span> </span>{
            <span class="hljs-keyword">return</span> viewType &gt;= <span class="hljs-number">0</span>;
        }

        <span class="hljs-javadoc">/**
         * Clears the scrap heap.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;
                clearScrap(scrap);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> typeCount = mViewTypeCount;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; typeCount; i++) {
                    <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];
                    clearScrap(scrap);
                }
            }

            clearTransientStateViews();
        }

        <span class="hljs-javadoc">/**
         * Fill ActiveViews with all of the children of the AbsListView.
         *
         *<span class="hljs-javadoctag"> @param</span> childCount The minimum number of views mActiveViews should hold
         *<span class="hljs-javadoctag"> @param</span> firstActivePosition The position of the first view that will be stored in
         *        mActiveViews
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fillActiveViews</span><span class="hljs-params">(<span class="hljs-keyword">int</span> childCount, <span class="hljs-keyword">int</span> firstActivePosition)</span> </span>{
            <span class="hljs-keyword">if</span> (mActiveViews.length &lt; childCount) {
                mActiveViews = <span class="hljs-keyword">new</span> View[childCount];
            }
            mFirstActivePosition = firstActivePosition;

            <span class="hljs-comment">//noinspection MismatchedReadAndWriteOfArray</span>
            <span class="hljs-keyword">final</span> View[] activeViews = mActiveViews;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; childCount; i++) {
                View child = getChildAt(i);
                AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();
                <span class="hljs-comment">// Don't put header or footer views into the scrap heap</span>
                <span class="hljs-keyword">if</span> (lp != <span class="hljs-keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) {
                    <span class="hljs-comment">// Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span>
                    <span class="hljs-comment">//        However, we will NOT place them into scrap views.</span>
                    activeViews[i] = child;
                }
            }
        }

        <span class="hljs-javadoc">/**
         * Get the view corresponding to the specified position. The view will be removed from
         * mActiveViews if it is found.
         *
         *<span class="hljs-javadoctag"> @param</span> position The position to look up in mActiveViews
         *<span class="hljs-javadoctag"> @return</span> The view if it is found, null otherwise
         */</span>
        <span class="hljs-function">View <span class="hljs-title">getActiveView</span><span class="hljs-params">(<span class="hljs-keyword">int</span> position)</span> </span>{
            <span class="hljs-keyword">int</span> index = position - mFirstActivePosition;
            <span class="hljs-keyword">final</span> View[] activeViews = mActiveViews;
            <span class="hljs-keyword">if</span> (index &gt;=<span class="hljs-number">0</span> &amp;&amp; index &lt; activeViews.length) {
                <span class="hljs-keyword">final</span> View match = activeViews[index];
                activeViews[index] = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">return</span> match;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }

        <span class="hljs-function">View <span class="hljs-title">getTransientStateView</span><span class="hljs-params">(<span class="hljs-keyword">int</span> position)</span> </span>{
            <span class="hljs-keyword">if</span> (mAdapter != <span class="hljs-keyword">null</span> &amp;&amp; mAdapterHasStableIds &amp;&amp; mTransientStateViewsById != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">long</span> id = mAdapter.getItemId(position);
                View result = mTransientStateViewsById.get(id);
                mTransientStateViewsById.remove(id);
                <span class="hljs-keyword">return</span> result;
            }
            <span class="hljs-keyword">if</span> (mTransientStateViews != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> index = mTransientStateViews.indexOfKey(position);
                <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
                    View result = mTransientStateViews.valueAt(index);
                    mTransientStateViews.removeAt(index);
                    <span class="hljs-keyword">return</span> result;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }

        <span class="hljs-javadoc">/**
         * Dumps and fully detaches any currently saved views with transient
         * state.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearTransientStateViews</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">final</span> SparseArray&lt;View&gt; viewsByPos = mTransientStateViews;
            <span class="hljs-keyword">if</span> (viewsByPos != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> N = viewsByPos.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) {
                    removeDetachedView(viewsByPos.valueAt(i), <span class="hljs-keyword">false</span>);
                }
                viewsByPos.clear();
            }

            <span class="hljs-keyword">final</span> LongSparseArray&lt;View&gt; viewsById = mTransientStateViewsById;
            <span class="hljs-keyword">if</span> (viewsById != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> N = viewsById.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) {
                    removeDetachedView(viewsById.valueAt(i), <span class="hljs-keyword">false</span>);
                }
                viewsById.clear();
            }
        }

        <span class="hljs-javadoc">/**
         *<span class="hljs-javadoctag"> @return</span> A view from the ScrapViews collection. These are unordered.
         */</span>
        <span class="hljs-function">View <span class="hljs-title">getScrapView</span><span class="hljs-params">(<span class="hljs-keyword">int</span> position)</span> </span>{
            <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">retrieveFromScrap</span><span class="hljs-params">(mCurrentScrap, position)</span></span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> whichScrap = mAdapter.getItemViewType(position);
                <span class="hljs-keyword">if</span> (whichScrap &gt;= <span class="hljs-number">0</span> &amp;&amp; whichScrap &lt; mScrapViews.length) {
                    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">retrieveFromScrap</span><span class="hljs-params">(mScrapViews[whichScrap], position)</span></span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }

        <span class="hljs-javadoc">/**
         * Puts a view into the list of scrap views.
         * &lt;p&gt;
         * If the list data hasn't changed or the adapter has stable IDs, views
         * with transient state will be preserved for later retrieval.
         *
         *<span class="hljs-javadoctag"> @param</span> scrap The view to add
         *<span class="hljs-javadoctag"> @param</span> position The view's position within its parent
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addScrapView</span><span class="hljs-params">(View scrap, <span class="hljs-keyword">int</span> position)</span> </span>{
            <span class="hljs-keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();
            <span class="hljs-keyword">if</span> (lp == <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">return</span>;
            }

            lp.scrappedFromPosition = position;

            <span class="hljs-comment">// Remove but don't scrap header or footer views, or views that</span>
            <span class="hljs-comment">// should otherwise not be recycled.</span>
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> viewType = lp.viewType;
            <span class="hljs-keyword">if</span> (!shouldRecycleViewType(viewType)) {
                <span class="hljs-keyword">return</span>;
            }

            scrap.dispatchStartTemporaryDetach();

            <span class="hljs-comment">// The the accessibility state of the view may change while temporary</span>
            <span class="hljs-comment">// detached and we do not allow detached views to fire accessibility</span>
            <span class="hljs-comment">// events. So we are announcing that the subtree changed giving a chance</span>
            <span class="hljs-comment">// to clients holding on to a view in this subtree to refresh it.</span>
            notifyViewAccessibilityStateChangedIfNeeded(
                    AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);

            <span class="hljs-comment">// Don't scrap views that have transient state.</span>
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();
            <span class="hljs-keyword">if</span> (scrapHasTransientState) {
                <span class="hljs-keyword">if</span> (mAdapter != <span class="hljs-keyword">null</span> &amp;&amp; mAdapterHasStableIds) {
                    <span class="hljs-comment">// If the adapter has stable IDs, we can reuse the view for</span>
                    <span class="hljs-comment">// the same data.</span>
                    <span class="hljs-keyword">if</span> (mTransientStateViewsById == <span class="hljs-keyword">null</span>) {
                        mTransientStateViewsById = <span class="hljs-keyword">new</span> LongSparseArray&lt;View&gt;();
                    }
                    mTransientStateViewsById.put(lp.itemId, scrap);
                } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(!mDataChanged)</span> </span>{
                    <span class="hljs-comment">// If the data hasn't changed, we can reuse the views at</span>
                    <span class="hljs-comment">// their old positions.</span>
                    <span class="hljs-keyword">if</span> (mTransientStateViews == <span class="hljs-keyword">null</span>) {
                        mTransientStateViews = <span class="hljs-keyword">new</span> SparseArray&lt;View&gt;();
                    }
                    mTransientStateViews.put(position, scrap);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// Otherwise, we'll have to remove the view and start over.</span>
                    <span class="hljs-keyword">if</span> (mSkippedScrap == <span class="hljs-keyword">null</span>) {
                        mSkippedScrap = <span class="hljs-keyword">new</span> ArrayList&lt;View&gt;();
                    }
                    mSkippedScrap.add(scrap);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                    mCurrentScrap.add(scrap);
                } <span class="hljs-keyword">else</span> {
                    mScrapViews[viewType].add(scrap);
                }

                <span class="hljs-keyword">if</span> (mRecyclerListener != <span class="hljs-keyword">null</span>) {
                    mRecyclerListener.onMovedToScrapHeap(scrap);
                }
            }
        }

        <span class="hljs-javadoc">/**
         * Finish the removal of any views that skipped the scrap heap.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">removeSkippedScrap</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (mSkippedScrap == <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = mSkippedScrap.size();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
                removeDetachedView(mSkippedScrap.get(i), <span class="hljs-keyword">false</span>);
            }
            mSkippedScrap.clear();
        }

        <span class="hljs-javadoc">/**
         * Move all views remaining in mActiveViews to mScrapViews.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scrapActiveViews</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">final</span> View[] activeViews = mActiveViews;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> hasListener = mRecyclerListener != <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> multipleScraps = mViewTypeCount &gt; <span class="hljs-number">1</span>;

            ArrayList&lt;View&gt; scrapViews = mCurrentScrap;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = activeViews.length;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = count - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
                <span class="hljs-keyword">final</span> View victim = activeViews[i];
                <span class="hljs-keyword">if</span> (victim != <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">final</span> AbsListView.LayoutParams lp
                            = (AbsListView.LayoutParams) victim.getLayoutParams();
                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> whichScrap = lp.viewType;

                    activeViews[i] = <span class="hljs-keyword">null</span>;

                    <span class="hljs-keyword">if</span> (victim.hasTransientState()) {
                        <span class="hljs-comment">// Store views with transient state for later use.</span>
                        victim.dispatchStartTemporaryDetach();

                        <span class="hljs-keyword">if</span> (mAdapter != <span class="hljs-keyword">null</span> &amp;&amp; mAdapterHasStableIds) {
                            <span class="hljs-keyword">if</span> (mTransientStateViewsById == <span class="hljs-keyword">null</span>) {
                                mTransientStateViewsById = <span class="hljs-keyword">new</span> LongSparseArray&lt;View&gt;();
                            }
                            <span class="hljs-keyword">long</span> id = mAdapter.getItemId(mFirstActivePosition + i);
                            mTransientStateViewsById.put(id, victim);
                        } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(!mDataChanged)</span> </span>{
                            <span class="hljs-keyword">if</span> (mTransientStateViews == <span class="hljs-keyword">null</span>) {
                                mTransientStateViews = <span class="hljs-keyword">new</span> SparseArray&lt;View&gt;();
                            }
                            mTransientStateViews.put(mFirstActivePosition + i, victim);
                        } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER)</span> </span>{
                            <span class="hljs-comment">// The data has changed, we can't keep this view.</span>
                            removeDetachedView(victim, <span class="hljs-keyword">false</span>);
                        }
                    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(!shouldRecycleViewType(whichScrap)</span>) </span>{
                        <span class="hljs-comment">// Discard non-recyclable views except headers/footers.</span>
                        <span class="hljs-keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) {
                            removeDetachedView(victim, <span class="hljs-keyword">false</span>);
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// Store everything else on the appropriate scrap heap.</span>
                        <span class="hljs-keyword">if</span> (multipleScraps) {
                            scrapViews = mScrapViews[whichScrap];
                        }

                        victim.dispatchStartTemporaryDetach();
                        lp.scrappedFromPosition = mFirstActivePosition + i;
                        scrapViews.add(victim);

                        <span class="hljs-keyword">if</span> (hasListener) {
                            mRecyclerListener.onMovedToScrapHeap(victim);
                        }
                    }
                }
            }

            pruneScrapViews();
        }

        <span class="hljs-javadoc">/**
         * Makes sure that the size of mScrapViews does not exceed the size of
         * mActiveViews, which can happen if an adapter does not recycle its
         * views. Removes cached transient state views that no longer have
         * transient state.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pruneScrapViews</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxViews = mActiveViews.length;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> viewTypeCount = mViewTypeCount;
            <span class="hljs-keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; viewTypeCount; ++i) {
                <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];
                <span class="hljs-keyword">int</span> size = scrapPile.size();
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> extras = size - maxViews;
                size--;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; extras; j++) {
                    removeDetachedView(scrapPile.remove(size--), <span class="hljs-keyword">false</span>);
                }
            }

            <span class="hljs-keyword">final</span> SparseArray&lt;View&gt; transViewsByPos = mTransientStateViews;
            <span class="hljs-keyword">if</span> (transViewsByPos != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; transViewsByPos.size(); i++) {
                    <span class="hljs-keyword">final</span> View v = transViewsByPos.valueAt(i);
                    <span class="hljs-keyword">if</span> (!v.hasTransientState()) {
                        removeDetachedView(v, <span class="hljs-keyword">false</span>);
                        transViewsByPos.removeAt(i);
                        i--;
                    }
                }
            }

            <span class="hljs-keyword">final</span> LongSparseArray&lt;View&gt; transViewsById = mTransientStateViewsById;
            <span class="hljs-keyword">if</span> (transViewsById != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; transViewsById.size(); i++) {
                    <span class="hljs-keyword">final</span> View v = transViewsById.valueAt(i);
                    <span class="hljs-keyword">if</span> (!v.hasTransientState()) {
                        removeDetachedView(v, <span class="hljs-keyword">false</span>);
                        transViewsById.removeAt(i);
                        i--;
                    }
                }
            }
        }

        <span class="hljs-javadoc">/**
         * Puts all views in the scrap heap into the supplied list.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reclaimScrapViews</span><span class="hljs-params">(List&lt;View&gt; views)</span> </span>{
            <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                views.addAll(mCurrentScrap);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> viewTypeCount = mViewTypeCount;
                <span class="hljs-keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; viewTypeCount; ++i) {
                    <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];
                    views.addAll(scrapPile);
                }
            }
        }

        <span class="hljs-javadoc">/**
         * Updates the cache color hint of all known views.
         *
         *<span class="hljs-javadoctag"> @param</span> color The new cache color hint.
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setCacheColorHint</span><span class="hljs-params">(<span class="hljs-keyword">int</span> color)</span> </span>{
            <span class="hljs-keyword">if</span> (mViewTypeCount == <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> scrapCount = scrap.size();
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; scrapCount; i++) {
                    scrap.get(i).setDrawingCacheBackgroundColor(color);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> typeCount = mViewTypeCount;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; typeCount; i++) {
                    <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];
                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> scrapCount = scrap.size();
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; scrapCount; j++) {
                        scrap.get(j).setDrawingCacheBackgroundColor(color);
                    }
                }
            }
            <span class="hljs-comment">// Just in case this is called during a layout pass</span>
            <span class="hljs-keyword">final</span> View[] activeViews = mActiveViews;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = activeViews.length;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {
                <span class="hljs-keyword">final</span> View victim = activeViews[i];
                <span class="hljs-keyword">if</span> (victim != <span class="hljs-keyword">null</span>) {
                    victim.setDrawingCacheBackgroundColor(color);
                }
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> View <span class="hljs-title">retrieveFromScrap</span><span class="hljs-params">(ArrayList&lt;View&gt; scrapViews, <span class="hljs-keyword">int</span> position)</span> </span>{
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> size = scrapViews.size();
            <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// See if we still have a view for this position or ID.</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
                    <span class="hljs-keyword">final</span> View view = scrapViews.get(i);
                    <span class="hljs-keyword">final</span> AbsListView.LayoutParams params =
                            (AbsListView.LayoutParams) view.getLayoutParams();

                    <span class="hljs-keyword">if</span> (mAdapterHasStableIds) {
                        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> id = mAdapter.getItemId(position);
                        <span class="hljs-keyword">if</span> (id == params.itemId) {
                            <span class="hljs-keyword">return</span> scrapViews.remove(i);
                        }
                    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(params.scrappedFromPosition == position)</span> </span>{
                        <span class="hljs-keyword">final</span> View scrap = scrapViews.remove(i);
                        clearAccessibilityFromScrap(scrap);
                        <span class="hljs-keyword">return</span> scrap;
                    }
                }
                <span class="hljs-keyword">final</span> View scrap = scrapViews.remove(size - <span class="hljs-number">1</span>);
                clearAccessibilityFromScrap(scrap);
                <span class="hljs-keyword">return</span> scrap;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearScrap</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ArrayList&lt;View&gt; scrap)</span> </span>{
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> scrapCount = scrap.size();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; scrapCount; j++) {
                removeDetachedView(scrap.remove(scrapCount - <span class="hljs-number">1</span> - j), <span class="hljs-keyword">false</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearAccessibilityFromScrap</span><span class="hljs-params">(View view)</span> </span>{
            <span class="hljs-keyword">if</span> (view.isAccessibilityFocused()) {
                view.clearAccessibilityFocus();
            }
            view.setAccessibilityDelegate(<span class="hljs-keyword">null</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeDetachedView</span><span class="hljs-params">(View child, <span class="hljs-keyword">boolean</span> animate)</span> </span>{
            child.setAccessibilityDelegate(<span class="hljs-keyword">null</span>);
            AbsListView.<span class="hljs-keyword">this</span>.removeDetachedView(child, animate);
        }
    }
</code></pre>
<p>AbsListView的obtain方法</p>
<pre><code class="lang-java">
    <span class="hljs-javadoc">/**
     * Get a view and have it show the data associated with the specified
     * position. This is called when we have already discovered that the view is
     * not available for reuse in the recycle bin. The only choices left are
     * converting an old view or making a new one.
     *
     *<span class="hljs-javadoctag"> @param</span> position The position to display
     *<span class="hljs-javadoctag"> @param</span> isScrap Array of at least 1 boolean, the first entry will become true if
     *                the returned view was taken from the scrap heap, false if otherwise.
     *
     *<span class="hljs-javadoctag"> @return</span> A view displaying the data associated with the specified position
     */</span>
    <span class="hljs-function">View <span class="hljs-title">obtainView</span><span class="hljs-params">(<span class="hljs-keyword">int</span> position, <span class="hljs-keyword">boolean</span>[] isScrap)</span> </span>{
        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="hljs-string">"obtainView"</span>);

        isScrap[<span class="hljs-number">0</span>] = <span class="hljs-keyword">false</span>;

        <span class="hljs-comment">// Check whether we have a transient state view. Attempt to re-bind the</span>
        <span class="hljs-comment">// data and discard the view if we fail.</span>
        <span class="hljs-keyword">final</span> View transientView = mRecycler.getTransientStateView(position);
        <span class="hljs-keyword">if</span> (transientView != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();

            <span class="hljs-comment">// If the view type hasn't changed, attempt to re-bind the data.</span>
            <span class="hljs-keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) {
                <span class="hljs-keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="hljs-keyword">this</span>);

                <span class="hljs-comment">// If we failed to re-bind the data, scrap the obtained view.</span>
                <span class="hljs-keyword">if</span> (updatedView != transientView) {
                    setItemViewLayoutParams(updatedView, position);
                    mRecycler.addScrapView(updatedView, position);
                }
            }

            <span class="hljs-comment">// Scrap view implies temporary detachment.</span>
            isScrap[<span class="hljs-number">0</span>] = <span class="hljs-keyword">true</span>;
            <span class="hljs-keyword">return</span> transientView;
        }

        <span class="hljs-keyword">final</span> View scrapView = mRecycler.getScrapView(position);
        <span class="hljs-keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">if</span> (scrapView != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">if</span> (child != scrapView) {
                <span class="hljs-comment">// Failed to re-bind the data, return scrap to the heap.</span>
                mRecycler.addScrapView(scrapView, position);
            } <span class="hljs-keyword">else</span> {
                isScrap[<span class="hljs-number">0</span>] = <span class="hljs-keyword">true</span>;

                child.dispatchFinishTemporaryDetach();
            }
        }

        <span class="hljs-keyword">if</span> (mCacheColorHint != <span class="hljs-number">0</span>) {
            child.setDrawingCacheBackgroundColor(mCacheColorHint);
        }

        <span class="hljs-keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) {
            child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);
        }

        setItemViewLayoutParams(child, position);

        <span class="hljs-keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) {
            <span class="hljs-keyword">if</span> (mAccessibilityDelegate == <span class="hljs-keyword">null</span>) {
                mAccessibilityDelegate = <span class="hljs-keyword">new</span> ListItemAccessibilityDelegate();
            }
            <span class="hljs-keyword">if</span> (child.getAccessibilityDelegate() == <span class="hljs-keyword">null</span>) {
                child.setAccessibilityDelegate(mAccessibilityDelegate);
            }
        }

        Trace.traceEnd(Trace.TRACE_TAG_VIEW);

        <span class="hljs-keyword">return</span> child;
    }
</code></pre>
<h4 id="1.2Adapter刷新">1.2Adapter刷新</h4>

<p>Adapter刷新调用ListView中定义的DataSetObserver的onChanged方法。</p>
<pre><code class="lang-java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdapterDataSetObserver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DataSetObserver</span> </span>{

        <span class="hljs-keyword">private</span> Parcelable mInstanceState = <span class="hljs-keyword">null</span>;

        <span class="hljs-annotation">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onChanged</span><span class="hljs-params">()</span> </span>{
            mDataChanged = <span class="hljs-keyword">true</span>;
            mOldItemCount = mItemCount;
            mItemCount = getAdapter().getCount();

            <span class="hljs-comment">// Detect the case where a cursor that was previously invalidated has</span>
            <span class="hljs-comment">// been repopulated with new data.</span>
            <span class="hljs-keyword">if</span> (AdapterView.<span class="hljs-keyword">this</span>.getAdapter().hasStableIds() &amp;&amp; mInstanceState != <span class="hljs-keyword">null</span>
                    &amp;&amp; mOldItemCount == <span class="hljs-number">0</span> &amp;&amp; mItemCount &gt; <span class="hljs-number">0</span>) {
                AdapterView.<span class="hljs-keyword">this</span>.onRestoreInstanceState(mInstanceState);
                mInstanceState = <span class="hljs-keyword">null</span>;
            } <span class="hljs-keyword">else</span> {
                rememberSyncState();
            }
            checkFocus();
            requestLayout();
        }

     ...
</code></pre>
<pre><code class="lang-java"> <span class="hljs-javadoc">/**
     * Remember enough information to restore the screen state when the data has
     * changed.
     *
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rememberSyncState</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (getChildCount() &gt; <span class="hljs-number">0</span>) {
            mNeedSync = <span class="hljs-keyword">true</span>;
            mSyncHeight = mLayoutHeight;
            <span class="hljs-keyword">if</span> (mSelectedPosition &gt;= <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// Sync the selection state</span>
                View v = getChildAt(mSelectedPosition - mFirstPosition);
                mSyncRowId = mNextSelectedRowId;
                mSyncPosition = mNextSelectedPosition;
                <span class="hljs-keyword">if</span> (v != <span class="hljs-keyword">null</span>) {
                    mSpecificTop = v.getTop();
                }
                mSyncMode = SYNC_SELECTED_POSITION;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Sync the based on the offset of the first view</span>
                View v = getChildAt(<span class="hljs-number">0</span>);
                T adapter = getAdapter();
                <span class="hljs-keyword">if</span> (mFirstPosition &gt;= <span class="hljs-number">0</span> &amp;&amp; mFirstPosition &lt; adapter.getCount()) {
                    mSyncRowId = adapter.getItemId(mFirstPosition);
                } <span class="hljs-keyword">else</span> {
                    mSyncRowId = NO_ID;
                }
                mSyncPosition = mFirstPosition;
                <span class="hljs-keyword">if</span> (v != <span class="hljs-keyword">null</span>) {
                    mSpecificTop = v.getTop();
                }
                mSyncMode = SYNC_FIRST_POSITION;
            }
        }
    }
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-disqus/plugin.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"disqus":{"shortName":"malinkang"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
