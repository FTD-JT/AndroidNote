'use strict';

var React = require('react');
var classNames = require('classnames');

var Input = require('./Input');
var Spinner = require('./Spinner');

var KEYCODE_ENTER = 13;
var KEYCODE_UP = 38;
var KEYCODE_DOWN = 40;

var Autocomplete = React.createClass({
    displayName: 'Autocomplete',
    getInitialState: function getInitialState() {
        return {
            value: this.props.value || '',
            cursor: null,
            loading: false,
            focused: false,
            results: []
        };
    },


    /**
     * Typed value changed, we fetch the new autocomplete result
     */
    onInputChanged: function onInputChanged(e) {
        var that = this;
        var onFetch = this.props.onFetch;
        var value = e.target.value;

        this.setState({
            value: value,
            loading: true
        });

        onFetch(value, function (results) {
            that.setState({
                loading: false,
                results: results
            });
        });
    },


    /**
     * User is focusing/blur the input
     */
    onFocusChanged: function onFocusChanged(isFocused) {
        this.setState({
            focused: isFocused
        });
    },


    /**
     * Submit value at cursor
     */
    onEnter: function onEnter() {
        var _state = this.state;
        var cursor = _state.cursor;
        var value = _state.value;
        var onEnter = this.props.onEnter;

        if (cursor >= 0) {
            this.onSelect(cursor);
        } else if (onEnter) {
            onEnter(value);
            this.setState({
                focused: false,
                cursor: null,
                results: [],
                value: ''
            });
        }
    },


    /**
     * Submit a value
     */
    onSelect: function onSelect(index) {
        var _state2 = this.state;
        var value = _state2.value;
        var results = _state2.results;

        var selected = results[index];

        this.setState({
            cursor: null,
            results: [],
            value: ''
        });

        this.props.onChange(value, selected);
    },


    /**
     * User pressed a key in text input
     */
    onKeyDown: function onKeyDown(e) {
        var _state3 = this.state;
        var cursor = _state3.cursor;
        var results = _state3.results;


        if (e.keyCode === KEYCODE_ENTER) {
            e.preventDefault();
            this.onEnter();
        } else if (e.keyCode === KEYCODE_DOWN) {
            e.preventDefault();
            cursor++;
        } else if (e.keyCode === KEYCODE_UP) {
            e.preventDefault();
            cursor--;
        }

        if (cursor >= results.length) {
            cursor = results.length - 1;
        }
        if (cursor < -1) {
            cursor = -1;
        }

        this.setState({
            cursor: cursor
        });
    },


    /**
     * Render the suggestions
     */
    renderResults: function renderResults() {
        var that = this;
        var _state4 = this.state;
        var results = _state4.results;
        var value = _state4.value;
        var cursor = _state4.cursor;

        var ResultComponent = this.props.renderResult;

        return React.createElement(
            'div',
            { className: 'AutocompleteResults' },
            results.map(function (result, i) {
                var isActive = i === cursor;

                return React.createElement(
                    AutocompleteResult,
                    { key: value + '-' + i, active: isActive,
                        onClick: function onClick(e) {
                            return that.onSelect(i);
                        } },
                    React.createElement(ResultComponent, { result: result, index: i, active: isActive })
                );
            })
        );
    },
    render: function render() {
        var _this = this;

        var _state5 = this.state;
        var value = _state5.value;
        var focused = _state5.focused;
        var loading = _state5.loading;
        var results = _state5.results;


        return React.createElement(
            'div',
            { className: 'Autocomplete' },
            React.createElement(Input, {
                value: value,
                placeholder: this.props.placeholder,
                size: this.props.size,
                onChange: this.onInputChanged,
                onFocus: function onFocus(e) {
                    return _this.onFocusChanged(true);
                },
                onBlur: function onBlur(e) {
                    return _this.onFocusChanged(false);
                },
                onKeyDown: this.onKeyDown
            }),
            loading ? React.createElement(Spinner, { size: 'sm', centered: false }) : '',
            focused && results.length > 0 ? this.renderResults() : ''
        );
    }
});

var AutocompleteResult = React.createClass({
    displayName: 'AutocompleteResult',
    render: function render() {
        var _props = this.props;
        var active = _props.active;
        var children = _props.children;
        var onClick = _props.onClick;

        return React.createElement(
            'div',
            { className: classNames('AutocompleteResult', { active: active }),
                onMouseDown: onClick },
            children
        );
    }
});

module.exports = Autocomplete;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BdXRvY29tcGxldGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLFFBQVEsUUFBUSxPQUFSLENBQWQ7QUFDQSxJQUFNLGFBQWEsUUFBUSxZQUFSLENBQW5COztBQUVBLElBQU0sUUFBUSxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQU0sVUFBVSxRQUFRLFdBQVIsQ0FBaEI7O0FBRUEsSUFBTSxnQkFBZ0IsRUFBdEI7QUFDQSxJQUFNLGFBQWdCLEVBQXRCO0FBQ0EsSUFBTSxlQUFnQixFQUF0Qjs7QUFFQSxJQUFNLGVBQWUsTUFBTSxXQUFOLENBQWtCO0FBQUE7QUFhbkMsbUJBYm1DLDZCQWFqQjtBQUNkLGVBQU87QUFDSCxtQkFBUyxLQUFLLEtBQUwsQ0FBVyxLQUFYLElBQW9CLEVBRDFCO0FBRUgsb0JBQVMsSUFGTjtBQUdILHFCQUFTLEtBSE47QUFJSCxxQkFBUyxLQUpOO0FBS0gscUJBQVM7QUFMTixTQUFQO0FBT0gsS0FyQmtDOzs7QUF1Qm5DOzs7QUFHQSxrQkExQm1DLDBCQTBCcEIsQ0ExQm9CLEVBMEJqQjtBQUNkLFlBQU0sT0FBTyxJQUFiO0FBQ0EsWUFBTSxVQUFVLEtBQUssS0FBTCxDQUFXLE9BQTNCO0FBQ0EsWUFBTSxRQUFTLEVBQUUsTUFBRixDQUFTLEtBQXhCOztBQUVBLGFBQUssUUFBTCxDQUFjO0FBQ1Ysd0JBRFU7QUFFVixxQkFBUztBQUZDLFNBQWQ7O0FBS0EsZ0JBQVEsS0FBUixFQUFlLFVBQVMsT0FBVCxFQUFrQjtBQUM3QixpQkFBSyxRQUFMLENBQWM7QUFDVix5QkFBUyxLQURDO0FBRVY7QUFGVSxhQUFkO0FBSUgsU0FMRDtBQU1ILEtBMUNrQzs7O0FBNENuQzs7O0FBR0Esa0JBL0NtQywwQkErQ3BCLFNBL0NvQixFQStDVDtBQUN0QixhQUFLLFFBQUwsQ0FBYztBQUNWLHFCQUFTO0FBREMsU0FBZDtBQUdILEtBbkRrQzs7O0FBcURuQzs7O0FBR0EsV0F4RG1DLHFCQXdEekI7QUFBQSxxQkFD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QixXQUM0QixPQUQ1Qjs7O0FBR0wsZUFDSTtBQUFBO0FBQUEsY0FBSyxXQUFVLGNBQWY7QUFDSSxnQ0FBQyxLQUFEO0FBQ0ksdUJBQU8sS0FEWDtBQUVJLDZCQUFhLEtBQUssS0FBTCxDQUFXLFdBRjVCO0FBR0ksc0JBQU0sS0FBSyxLQUFMLENBQVcsSUFIckI7QUFJSSwwQkFBVSxLQUFLLGNBSm5CO0FBS0kseUJBQVM7QUFBQSwyQkFBSyxNQUFLLGNBQUwsQ0FBb0IsSUFBcEIsQ0FBTDtBQUFBLGlCQUxiO0FBTUksd0JBQVE7QUFBQSwyQkFBSyxNQUFLLGNBQUwsQ0FBb0IsS0FBcEIsQ0FBTDtBQUFBLGlCQU5aO0FBT0ksMkJBQVcsS0FBSztBQVBwQixjQURKO0FBVUssc0JBQVMsb0JBQUMsT0FBRCxJQUFTLE1BQUssSUFBZCxFQUFtQixVQUFVLEtBQTdCLEdBQVQsR0FBa0QsRUFWdkQ7QUFXSyx1QkFBVyxRQUFRLE1BQVIsR0FBaUIsQ0FBNUIsR0FBK0IsS0FBSyxhQUFMLEVBQS9CLEdBQXNEO0FBWDNELFNBREo7QUFlSDtBQS9Ka0MsQ0FBbEIsQ0FBckI7O0FBa0tBLElBQU0scUJBQXFCLE1BQU0sV0FBTixDQUFrQjtBQUFBO0FBT3pDLFVBUHlDLG9CQU9oQztBQUFBLHFCQUNpQyxLQUFLLEtBRHRDO0FBQUEsWUFDRyxNQURILFVBQ0csTUFESDtBQUFBLFlBQ1csUUFEWCxVQUNXLFFBRFg7QUFBQSxZQUNxQixPQURyQixVQUNxQixPQURyQjs7QUFFTCxlQUNJO0FBQUE7QUFBQSxjQUFLLFdBQVcsV0FBVyxvQkFBWCxFQUFpQyxFQUFFLGNBQUYsRUFBakMsQ0FBaEI7QUFDSyw2QkFBYSxPQURsQjtBQUVLO0FBRkwsU0FESjtBQU1IO0FBZndDLENBQWxCLENBQTNCOztBQWtCQSxPQUFPLE9BQVAsR0FBaUIsWUFBakIiLCJmaWxlIjoiQXV0b2NvbXBsZXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xuY29uc3QgY2xhc3NOYW1lcyA9IHJlcXVpcmUoJ2NsYXNzbmFtZXMnKTtcblxuY29uc3QgSW5wdXQgPSByZXF1aXJlKCcuL0lucHV0Jyk7XG5jb25zdCBTcGlubmVyID0gcmVxdWlyZSgnLi9TcGlubmVyJyk7XG5cbmNvbnN0IEtFWUNPREVfRU5URVIgPSAxMztcbmNvbnN0IEtFWUNPREVfVVAgICAgPSAzODtcbmNvbnN0IEtFWUNPREVfRE9XTiAgPSA0MDtcblxuY29uc3QgQXV0b2NvbXBsZXRlID0gUmVhY3QuY3JlYXRlQ2xhc3Moe1xuICAgIHByb3BUeXBlczoge1xuICAgICAgICBvbkZldGNoOiAgICAgIFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICAgICAgICByZW5kZXJSZXN1bHQ6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICAgICAgICAvLyBDYWxsZWQgd2hlbiBvbkVudGVyIG9uIHRoZSBpbnB1dCAobm8gcmVzdWx0IHNlbGVjdGVkKVxuICAgICAgICAvLyBxdWVyeSAtPiAoKVxuICAgICAgICBvbkVudGVyOiAgICAgIFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICAgICAgICB2YWx1ZTogICAgICAgIFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIHBsYWNlaG9sZGVyOiAgUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgc2l6ZTogICAgICAgICBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBvbkNoYW5nZTogICAgIFJlYWN0LlByb3BUeXBlcy5mdW5jXG4gICAgfSxcblxuICAgIGdldEluaXRpYWxTdGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbHVlOiAgIHRoaXMucHJvcHMudmFsdWUgfHwgJycsXG4gICAgICAgICAgICBjdXJzb3I6ICBudWxsLFxuICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICBmb2N1c2VkOiBmYWxzZSxcbiAgICAgICAgICAgIHJlc3VsdHM6IFtdXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFR5cGVkIHZhbHVlIGNoYW5nZWQsIHdlIGZldGNoIHRoZSBuZXcgYXV0b2NvbXBsZXRlIHJlc3VsdFxuICAgICAqL1xuICAgIG9uSW5wdXRDaGFuZ2VkKGUpIHtcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgIGNvbnN0IG9uRmV0Y2ggPSB0aGlzLnByb3BzLm9uRmV0Y2g7XG4gICAgICAgIGNvbnN0IHZhbHVlICA9IGUudGFyZ2V0LnZhbHVlO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICBsb2FkaW5nOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG9uRmV0Y2godmFsdWUsIGZ1bmN0aW9uKHJlc3VsdHMpIHtcbiAgICAgICAgICAgIHRoYXQuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJlc3VsdHNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVXNlciBpcyBmb2N1c2luZy9ibHVyIHRoZSBpbnB1dFxuICAgICAqL1xuICAgIG9uRm9jdXNDaGFuZ2VkKGlzRm9jdXNlZCkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGZvY3VzZWQ6IGlzRm9jdXNlZFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU3VibWl0IHZhbHVlIGF0IGN1cnNvclxuICAgICAqL1xuICAgIG9uRW50ZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgY3Vyc29yLCB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBvbkVudGVyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoY3Vyc29yID49IDApIHtcbiAgICAgICAgICAgIHRoaXMub25TZWxlY3QoY3Vyc29yKTtcbiAgICAgICAgfSBlbHNlIGlmIChvbkVudGVyKSB7XG4gICAgICAgICAgICBvbkVudGVyKHZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGZvY3VzZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGN1cnNvcjogbnVsbCxcbiAgICAgICAgICAgICAgICByZXN1bHRzOiBbXSxcbiAgICAgICAgICAgICAgICB2YWx1ZTogJydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFN1Ym1pdCBhIHZhbHVlXG4gICAgICovXG4gICAgb25TZWxlY3QgKGluZGV4KSB7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIHJlc3VsdHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gcmVzdWx0c1tpbmRleF07XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBjdXJzb3I6IG51bGwsXG4gICAgICAgICAgICByZXN1bHRzOiBbXSxcbiAgICAgICAgICAgIHZhbHVlOiAnJ1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKHZhbHVlLCBzZWxlY3RlZCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFVzZXIgcHJlc3NlZCBhIGtleSBpbiB0ZXh0IGlucHV0XG4gICAgICovXG4gICAgb25LZXlEb3duKGUpIHtcbiAgICAgICAgbGV0IHsgY3Vyc29yLCByZXN1bHRzIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IEtFWUNPREVfRU5URVIpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHRoaXMub25FbnRlcigpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGUua2V5Q29kZSA9PT0gS0VZQ09ERV9ET1dOKSB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBjdXJzb3IrKztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChlLmtleUNvZGUgPT09IEtFWUNPREVfVVApIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGN1cnNvci0tO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGN1cnNvciA+PSByZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICAgICAgY3Vyc29yID0gKHJlc3VsdHMubGVuZ3RoIC0gMSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1cnNvciA8IC0xKSB7XG4gICAgICAgICAgICBjdXJzb3IgPSAtMTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgY3Vyc29yXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZW5kZXIgdGhlIHN1Z2dlc3Rpb25zXG4gICAgICovXG4gICAgcmVuZGVyUmVzdWx0cygpIHtcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgIGNvbnN0IHsgcmVzdWx0cywgdmFsdWUsIGN1cnNvciB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgUmVzdWx0Q29tcG9uZW50ID0gdGhpcy5wcm9wcy5yZW5kZXJSZXN1bHQ7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiQXV0b2NvbXBsZXRlUmVzdWx0c1wiPlxuICAgICAgICAgICAgICAgIHtyZXN1bHRzLm1hcChmdW5jdGlvbihyZXN1bHQsIGkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSAoaSA9PT0gY3Vyc29yKTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gPEF1dG9jb21wbGV0ZVJlc3VsdCBrZXk9e3ZhbHVlKyctJytpfSBhY3RpdmU9e2lzQWN0aXZlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17ZSA9PiB0aGF0Lm9uU2VsZWN0KGkpfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxSZXN1bHRDb21wb25lbnQgcmVzdWx0PXtyZXN1bHR9IGluZGV4PXtpfSBhY3RpdmU9e2lzQWN0aXZlfSAvPlxuICAgICAgICAgICAgICAgICAgICA8L0F1dG9jb21wbGV0ZVJlc3VsdD47XG4gICAgICAgICAgICAgICAgfSl9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlLCBmb2N1c2VkLCBsb2FkaW5nLCByZXN1bHRzIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIkF1dG9jb21wbGV0ZVwiPlxuICAgICAgICAgICAgICAgIDxJbnB1dFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dmFsdWV9XG4gICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXt0aGlzLnByb3BzLnBsYWNlaG9sZGVyfVxuICAgICAgICAgICAgICAgICAgICBzaXplPXt0aGlzLnByb3BzLnNpemV9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uSW5wdXRDaGFuZ2VkfVxuICAgICAgICAgICAgICAgICAgICBvbkZvY3VzPXtlID0+IHRoaXMub25Gb2N1c0NoYW5nZWQodHJ1ZSl9XG4gICAgICAgICAgICAgICAgICAgIG9uQmx1cj17ZSA9PiB0aGlzLm9uRm9jdXNDaGFuZ2VkKGZhbHNlKX1cbiAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXt0aGlzLm9uS2V5RG93bn1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIHtsb2FkaW5nPyA8U3Bpbm5lciBzaXplPVwic21cIiBjZW50ZXJlZD17ZmFsc2V9IC8+IDogJyd9XG4gICAgICAgICAgICAgICAge2ZvY3VzZWQgJiYgcmVzdWx0cy5sZW5ndGggPiAwPyB0aGlzLnJlbmRlclJlc3VsdHMoKSA6ICcnfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufSk7XG5cbmNvbnN0IEF1dG9jb21wbGV0ZVJlc3VsdCA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcbiAgICBwcm9wVHlwZXM6IHtcbiAgICAgICAgYWN0aXZlOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbCxcbiAgICAgICAgb25DbGljazogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG4gICAgICAgIGNoaWxkcmVuOiBSZWFjdC5Qcm9wVHlwZXMubm9kZVxuICAgIH0sXG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgYWN0aXZlLCBjaGlsZHJlbiwgb25DbGljayB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWVzKCdBdXRvY29tcGxldGVSZXN1bHQnLCB7IGFjdGl2ZSB9KX1cbiAgICAgICAgICAgICAgICAgb25Nb3VzZURvd249e29uQ2xpY2t9PlxuICAgICAgICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IEF1dG9jb21wbGV0ZTtcbiJdfQ==