'use strict';

var React = require('react');
var classNames = require('classnames');

var SIZES = require('./SIZES');
var Button = require('./Button');
var Input = require('./Input');
var Backdrop = require('./Backdrop');

var DEFAULT_SEARCH_PLACEHOLDER = 'Search';

var itemShape = React.PropTypes.oneOfType([React.PropTypes.string, React.PropTypes.object]);

var groupShape = React.PropTypes.shape({
    label: React.PropTypes.string,
    options: React.PropTypes.arrayOf(itemShape)
});

/**
 * Default filter for select
 */
function defaultFilter(query, item, i) {
    return true;
}

/**
 * Default render for options
 */
function defaultComponent(_ref) {
    var option = _ref.option;

    return React.createElement(
        'span',
        null,
        option
    );
}


/**
 * Default render to string for input
 */
function defaultRenderToString(item, i) {
    return String(item);
}

/**
 * Interractive select for forms
 *
 * It renders as a normal select on server and has a custom UI on browser (with search, images support).
 *
 * <Select name="test">
 *     <Select.Option key="en">English</Select.Option>
 *     <Select.Option key="fr">French</Select.Option>
 * </Select>
 */
var Select = React.createClass({
    displayName: 'Select',
    getDefaultProps: function getDefaultProps() {
        return {
            disabled: false,
            search: true,
            delimiter: ',',
            size: SIZES[0],
            multiple: false,
            block: false,
            filter: defaultFilter,
            component: defaultComponent,
            renderToString: defaultRenderToString,
            searchPlaceholder: DEFAULT_SEARCH_PLACEHOLDER,
            placeholder: 'Select'
        };
    },
    getInitialState: function getInitialState() {
        return {
            value: this.props.value,
            query: '',
            opened: false,
            groups: this.propsToGroups(this.props)
        };
    },
    componentWillReceiveProps: function componentWillReceiveProps(newProps) {
        this.setState({
            value: newProps.value,
            groups: this.propsToGroups(newProps),
            opened: newProps.disabled ? false : this.state.opened
        });
    },


    /**
     * Create list of groups from props
     * @param {Object} props
     * @return {Array<groupShape>}
     */
    propsToGroups: function propsToGroups(props) {
        var _props = this.props;
        var options = _props.options;
        var groups = _props.groups;


        if (groups) {
            return groups;
        }

        return [{ options: options }];
    },


    /**
     * Search query changed
     */
    onSearchChanged: function onSearchChanged(e) {
        this.setState({
            query: e.target.value
        });
    },


    /**
     * Toggle (close/open) the select
     */
    onToggle: function onToggle() {
        this.setState({
            opened: !this.state.opened
        });
    },


    /**
     * Close the select
     */
    close: function close() {
        this.setState({
            opened: false
        });
    },


    /**
     * Open the select
     */
    open: function open() {
        this.setState({
            opened: false
        });
    },


    /**
     * Focus the search if open
     */
    focusOnOpen: function focusOnOpen() {
        if (this.state.opened) {
            this.focusSearch();
        }
    },
    componentDidUpdate: function componentDidUpdate() {
        this.focusOnOpen();
    },
    componentDidMount: function componentDidMount() {
        this.focusOnOpen();
    },


    /**
     * Toggle an option
     */
    onToggleOption: function onToggleOption(addValue, e) {
        if (e) {
            e.preventDefault();
        }

        var _state = this.state;
        var value = _state.value;
        var multiple = _state.multiple;
        var onChange = this.props.onChange;

        var newState = void 0,
            newValue = void 0;

        if (multiple) {
            newValue = value;

            // Add to selection if not yet selected
            if (!this.hasValue(addValue)) {
                newValue = value.concat([addValue]);
            } else if (value.length > 1) {
                // Unselect if many options are selected
                newValue.splice(newValue.indexOf(addValue), 1);
            }

            newState = {
                value: newValue
            };
        } else {
            newValue = addValue;

            newState = {
                value: addValue,
                opened: false
            };
        }

        this.setState(newState, function () {
            if (onChange) {
                onChange(newValue);
            }
        });
    },


    /**
     * Get current value as a string (for hidden input)
     * @return {String}
     */
    getStringValue: function getStringValue() {
        var _props2 = this.props;
        var value = _props2.value;
        var renderToString = _props2.renderToString;


        if (!value) {
            return '';
        }

        if (!this.props.multiple) {
            return renderToString(value);
        } else {
            return value.map(renderToString).join(this.props.delimiter);
        }
    },


    /**
     * Check if a value is selected
     * @param {String} value
     * @return {Boolean}
     */
    hasValue: function hasValue(value) {
        var currentValue = this.state.value;

        if (!this.props.multiple) {
            return currentValue === value;
        } else {
            return currentValue.indexOf(value) >= 0;
        }
    },


    /**
     * Focus the search input
     */
    focusSearch: function focusSearch() {
        var searchInput = this.refs.searchInput;

        if (!searchInput) {
            return;
        }

        searchInput.focus();
    },


    /**
     * Render button to open select
     */
    renderButton: function renderButton() {
        var _props3 = this.props;
        var disabled = _props3.disabled;
        var block = _props3.block;
        var multiple = _props3.multiple;
        var placeholder = _props3.placeholder;
        var _state2 = this.state;
        var value = _state2.value;
        var opened = _state2.opened;

        var ComponentSelection = this.props.componentSelection || this.props.component;

        var inner = void 0;

        if (value) {
            var values = multiple ? value : [value];
            inner = React.createElement(
                'span',
                { className: 'SelectSelections' },
                values.map(function (val, i) {
                    return React.createElement(
                        'span',
                        { key: i, className: 'SelectSelection' },
                        React.createElement(ComponentSelection, { option: val, index: i })
                    );
                })
            );
        } else {
            inner = React.createElement(
                'span',
                { className: 'SelectPlaceholder' },
                placeholder
            );
        }

        return React.createElement(
            Button,
            { size: this.props.size, block: block, disabled: disabled, active: opened, onClick: this.onToggle },
            inner,
            ' ',
            React.createElement(Button.Caret, null)
        );
    },


    /**
     * Render button to open select
     */
    renderSearch: function renderSearch() {
        var query = this.state.query;


        return React.createElement(
            'div',
            { className: 'SelectSearch' },
            React.createElement(Input, { ref: 'searchInput',
                value: query,
                onChange: this.onSearchChanged,
                placeholder: this.props.placeholder
            })
        );
    },


    /**
     * Render the options selector
     */
    renderGroup: function renderGroup(group, index) {
        var query = this.state.query;
        var filter = this.props.filter;

        var Component = this.props.component;
        var count = 0;

        var options = group.options.map(function (item, i) {
            var _this = this;

            if (!filter(query, item, i)) {
                return '';
            }

            count++;

            return React.createElement(
                'div',
                {
                    key: i,
                    className: classNames('SelectOption', { active: this.hasValue(item) }),
                    onClick: function onClick(e) {
                        return _this.onToggleOption(item);
                    }
                },
                React.createElement(Component, { option: item, index: i })
            );
        }, this);

        // Don't display empty groups (when filtered)
        if (count === 0) {
            return '';
        }

        return React.createElement(
            'div',
            { key: index, className: 'SelectOptGroup' },
            group.label ? React.createElement(
                'div',
                { className: 'GroupLabel' },
                group.label
            ) : '',
            React.createElement(
                'div',
                { className: 'GroupOptions' },
                options
            )
        );
    },


    /**
     * Render the groups
     */
    renderGroups: function renderGroups() {
        var _state3 = this.state;
        var opened = _state3.opened;
        var groups = _state3.groups;
        var search = this.props.search;


        var className = classNames('SelectContainer', {
            'open': opened
        });

        return React.createElement(
            'div',
            { className: className },
            search ? this.renderSearch() : '',
            React.createElement(
                'div',
                { className: 'SelectGroups' },
                groups.map(this.renderGroup)
            )
        );
    },
    render: function render() {
        var _props4 = this.props;
        var name = _props4.name;
        var block = _props4.block;
        var opened = this.state.opened;


        var className = classNames('SelectFormControl', {
            block: block
        });

        return React.createElement(
            'div',
            { className: className, onClick: function onClick(e) {
                    return e.stopPropagation();
                } },
            React.createElement('input', { type: 'hidden', name: name, value: this.getStringValue() }),
            this.renderButton(),
            opened ? React.createElement(
                Backdrop,
                { onClose: this.close },
                this.renderGroups()
            ) : ''
        );
    }
});

module.exports = Select;
//# sourceMappingURL=data:application/json;base64,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MkNBQU8sTUFBSyxRQUFaLEVBQXFCLE1BQU0sSUFBM0IsRUFBaUMsT0FBTyxLQUFLLGNBQUwsRUFBeEMsR0FESjtBQUVLLGlCQUFLLFlBQUwsRUFGTDtBQUdLLHFCQUFRO0FBQUMsd0JBQUQ7QUFBQSxrQkFBVSxTQUFTLEtBQUssS0FBeEI7QUFBZ0MscUJBQUssWUFBTDtBQUFoQyxhQUFSLEdBQTBFO0FBSC9FLFNBREo7QUFPSDtBQTNYNEIsQ0FBbEIsQ0FBZjs7QUE4WEEsT0FBTyxPQUFQLEdBQWlCLE1BQWpCIiwiZmlsZSI6IlNlbGVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFJlYWN0ICAgICAgPSByZXF1aXJlKCdyZWFjdCcpO1xuY29uc3QgY2xhc3NOYW1lcyA9IHJlcXVpcmUoJ2NsYXNzbmFtZXMnKTtcblxuY29uc3QgU0laRVMgICAgPSByZXF1aXJlKCcuL1NJWkVTJyk7XG5jb25zdCBCdXR0b24gICA9IHJlcXVpcmUoJy4vQnV0dG9uJyk7XG5jb25zdCBJbnB1dCAgICA9IHJlcXVpcmUoJy4vSW5wdXQnKTtcbmNvbnN0IEJhY2tkcm9wID0gcmVxdWlyZSgnLi9CYWNrZHJvcCcpO1xuXG5jb25zdCBERUZBVUxUX1NFQVJDSF9QTEFDRUhPTERFUiA9ICdTZWFyY2gnO1xuXG5jb25zdCBpdGVtU2hhcGUgPSBSZWFjdC5Qcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgIFJlYWN0LlByb3BUeXBlcy5vYmplY3Rcbl0pO1xuXG5jb25zdCBncm91cFNoYXBlID0gUmVhY3QuUHJvcFR5cGVzLnNoYXBlKHtcbiAgICBsYWJlbDogICBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgIG9wdGlvbnM6IFJlYWN0LlByb3BUeXBlcy5hcnJheU9mKGl0ZW1TaGFwZSlcbn0pO1xuXG4vKipcbiAqIERlZmF1bHQgZmlsdGVyIGZvciBzZWxlY3RcbiAqL1xuZnVuY3Rpb24gZGVmYXVsdEZpbHRlcihxdWVyeSwgaXRlbSwgaSkge1xuICAgIHJldHVybiB0cnVlO1xufVxuXG4vKipcbiAqIERlZmF1bHQgcmVuZGVyIGZvciBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIGRlZmF1bHRDb21wb25lbnQoe29wdGlvbn0pIHtcbiAgICByZXR1cm4gPHNwYW4+e29wdGlvbn08L3NwYW4+O1xufVxuZGVmYXVsdENvbXBvbmVudC5wcm9wVHlwZXMgPSB7XG4gICAgb3B0aW9uOiBpdGVtU2hhcGVcbn07XG5cbi8qKlxuICogRGVmYXVsdCByZW5kZXIgdG8gc3RyaW5nIGZvciBpbnB1dFxuICovXG5mdW5jdGlvbiBkZWZhdWx0UmVuZGVyVG9TdHJpbmcoaXRlbSwgaSkge1xuICAgIHJldHVybiBTdHJpbmcoaXRlbSk7XG59XG5cblxuLyoqXG4gKiBJbnRlcnJhY3RpdmUgc2VsZWN0IGZvciBmb3Jtc1xuICpcbiAqIEl0IHJlbmRlcnMgYXMgYSBub3JtYWwgc2VsZWN0IG9uIHNlcnZlciBhbmQgaGFzIGEgY3VzdG9tIFVJIG9uIGJyb3dzZXIgKHdpdGggc2VhcmNoLCBpbWFnZXMgc3VwcG9ydCkuXG4gKlxuICogPFNlbGVjdCBuYW1lPVwidGVzdFwiPlxuICogICAgIDxTZWxlY3QuT3B0aW9uIGtleT1cImVuXCI+RW5nbGlzaDwvU2VsZWN0Lk9wdGlvbj5cbiAqICAgICA8U2VsZWN0Lk9wdGlvbiBrZXk9XCJmclwiPkZyZW5jaDwvU2VsZWN0Lk9wdGlvbj5cbiAqIDwvU2VsZWN0PlxuICovXG5jb25zdCBTZWxlY3QgPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG4gICAgcHJvcFR5cGVzOiB7XG4gICAgICAgIC8vIEN1cnJlbnQgdmFsdWUgb2YgdGhlIHNlbGVjdFxuICAgICAgICB2YWx1ZTogICAgICAgICAgUmVhY3QuUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICAgICAgICBpdGVtU2hhcGUsXG4gICAgICAgICAgICBSZWFjdC5Qcm9wVHlwZXMuYXJyYXlPZihpdGVtU2hhcGUpXG4gICAgICAgIF0pLFxuXG4gICAgICAgIC8vIExpc3Qgb2YgaXRlbXMgdG8gZGlzcGxheVxuICAgICAgICBncm91cHM6ICAgICAgICAgUmVhY3QuUHJvcFR5cGVzLmFycmF5T2YoZ3JvdXBTaGFwZSksXG4gICAgICAgIG9wdGlvbnM6ICAgICAgICBSZWFjdC5Qcm9wVHlwZXMuYXJyYXlPZihpdGVtU2hhcGUpLFxuXG4gICAgICAgIC8vIEZ1bmN0aW9uIHRvIHJlbmRlciB0aGUgb3B0aW9uIHRvIGEgc3RyaW5nIG9yIGVsZW1lbnRcbiAgICAgICAgY29tcG9uZW50OiAgICAgUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG5cbiAgICAgICAgLy8gRnVuY3Rpb24gdG8gcmVuZGVyIHRoZSBzZWxlY3RlZCBvcHRpb24gaW4gdGhlIGJ1dHRvblxuICAgICAgICAvLyBEZWZhdWx0cyB0byBcInJlbmRlck9wdGlvblwiXG4gICAgICAgIGNvbXBvbmVudFNlbGVjdGlvbjogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG5cbiAgICAgICAgLy8gRnVuY3Rpb24gdG8gb3V0cHV0IGFuIG9wdGlvbiBhcyBhIHN0cmluZ1xuICAgICAgICAvLyBEZWZhdWx0cyB0byBhIHN0cmluZyByZXByZXNlbnRhdGlvbiwgeW91IGhhdmUgdG8gcHJvdmlkZSB5b3VyIG93biB2YWx1ZVxuICAgICAgICAvLyB3aGVuIHVzaW5nIGEgY3VzdG9tIG9wdGlvbiByZW5kZXJlclxuICAgICAgICByZW5kZXJUb1N0cmluZzogIFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuXG4gICAgICAgIC8vIEZ1bmN0aW9uIHRvIGZpbHRlciBhbiBlbGVtZW50XG4gICAgICAgIGZpbHRlcjogICAgICAgICBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcblxuICAgICAgICAvLyBPcHRpb25hbCBjYWxsYmFjayB3aGVuIHZhbHVlIGNoYW5nZWRcbiAgICAgICAgb25DaGFuZ2U6ICAgICAgIFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuXG4gICAgICAgIC8vIE5hbWUgd2hlbiB1c2luZyBzZXJ2ZXIgcG9zdGluZ1xuICAgICAgICBuYW1lOiAgICAgICAgICAgUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcblxuICAgICAgICAvLyBUZXh0IHRvIGRpc3BsYXkgd2hlbiBubyB2YWx1ZSBpcyBzZXRcbiAgICAgICAgcGxhY2Vob2xkZXI6ICAgIFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIHNlYXJjaFBsYWNlaG9sZGVyOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuXG4gICAgICAgIC8vIERlbGltaXRlciBmb3IgbXVsdGlwbGUgdmFsdWVzXG4gICAgICAgIGRlbGltaXRlcjogICAgICBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuXG4gICAgICAgIC8vIFByZXZlbnQgc2VsZWN0aW9uXG4gICAgICAgIGRpc2FibGVkOiAgICAgICBSZWFjdC5Qcm9wVHlwZXMuYm9vbCxcblxuICAgICAgICAvLyBEaXNwbGF5IHRoZSBzZWFyY2ggZmlsdGVyP1xuICAgICAgICBzZWFyY2g6ICAgICAgICAgUmVhY3QuUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAgICAgLy8gQWNjZXB0IG11bHRpcGxlIHZhbHVlc1xuICAgICAgICBtdWx0aXBsZTogICAgICAgUmVhY3QuUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAgICAgLy8gU2l6ZSBvZiB0aGUgc2VsZWN0IHRvIGRpc3BsYXlcbiAgICAgICAgc2l6ZTogICAgICAgICAgIFJlYWN0LlByb3BUeXBlcy5vbmVPZihTSVpFUyksXG5cbiAgICAgICAgLy8gVGFrZSB0aGUgd2hvbGUgd2lkdGhcbiAgICAgICAgYmxvY2s6ICAgICAgICAgIFJlYWN0LlByb3BUeXBlcy5ib29sXG4gICAgfSxcblxuICAgIGdldERlZmF1bHRQcm9wcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRpc2FibGVkOiAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIHNlYXJjaDogICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgZGVsaW1pdGVyOiAgICAgICAgICcsJyxcbiAgICAgICAgICAgIHNpemU6ICAgICAgICAgICAgICBTSVpFU1swXSxcbiAgICAgICAgICAgIG11bHRpcGxlOiAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGJsb2NrOiAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGZpbHRlcjogICAgICAgICAgICBkZWZhdWx0RmlsdGVyLFxuICAgICAgICAgICAgY29tcG9uZW50OiAgICAgICAgIGRlZmF1bHRDb21wb25lbnQsXG4gICAgICAgICAgICByZW5kZXJUb1N0cmluZzogICAgZGVmYXVsdFJlbmRlclRvU3RyaW5nLFxuICAgICAgICAgICAgc2VhcmNoUGxhY2Vob2xkZXI6IERFRkFVTFRfU0VBUkNIX1BMQUNFSE9MREVSLFxuICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICAgICAgICdTZWxlY3QnXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIGdldEluaXRpYWxTdGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbHVlOiAgICB0aGlzLnByb3BzLnZhbHVlLFxuICAgICAgICAgICAgcXVlcnk6ICAgICcnLFxuICAgICAgICAgICAgb3BlbmVkOiAgIGZhbHNlLFxuICAgICAgICAgICAgZ3JvdXBzOiAgIHRoaXMucHJvcHNUb0dyb3Vwcyh0aGlzLnByb3BzKVxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgdmFsdWU6ICBuZXdQcm9wcy52YWx1ZSxcbiAgICAgICAgICAgIGdyb3VwczogdGhpcy5wcm9wc1RvR3JvdXBzKG5ld1Byb3BzKSxcbiAgICAgICAgICAgIG9wZW5lZDogbmV3UHJvcHMuZGlzYWJsZWQ/IGZhbHNlIDogdGhpcy5zdGF0ZS5vcGVuZWRcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBsaXN0IG9mIGdyb3VwcyBmcm9tIHByb3BzXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHByb3BzXG4gICAgICogQHJldHVybiB7QXJyYXk8Z3JvdXBTaGFwZT59XG4gICAgICovXG4gICAgcHJvcHNUb0dyb3Vwcyhwcm9wcykge1xuICAgICAgICBjb25zdCB7IG9wdGlvbnMsIGdyb3VwcyAgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgaWYgKGdyb3Vwcykge1xuICAgICAgICAgICAgcmV0dXJuIGdyb3VwcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB7IG9wdGlvbnMgfVxuICAgICAgICBdO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTZWFyY2ggcXVlcnkgY2hhbmdlZFxuICAgICAqL1xuICAgIG9uU2VhcmNoQ2hhbmdlZChlKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcXVlcnk6IGUudGFyZ2V0LnZhbHVlXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBUb2dnbGUgKGNsb3NlL29wZW4pIHRoZSBzZWxlY3RcbiAgICAgKi9cbiAgICBvblRvZ2dsZSgpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBvcGVuZWQ6ICF0aGlzLnN0YXRlLm9wZW5lZFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgdGhlIHNlbGVjdFxuICAgICAqL1xuICAgIGNsb3NlKCkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIG9wZW5lZDogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIE9wZW4gdGhlIHNlbGVjdFxuICAgICAqL1xuICAgIG9wZW4oKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgb3BlbmVkOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRm9jdXMgdGhlIHNlYXJjaCBpZiBvcGVuXG4gICAgICovXG4gICAgZm9jdXNPbk9wZW4oKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9wZW5lZCkge1xuICAgICAgICAgICAgdGhpcy5mb2N1c1NlYXJjaCgpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy5mb2N1c09uT3BlbigpO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy5mb2N1c09uT3BlbigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBUb2dnbGUgYW4gb3B0aW9uXG4gICAgICovXG4gICAgb25Ub2dnbGVPcHRpb24oYWRkVmFsdWUsIGUpIHtcbiAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIG11bHRpcGxlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBsZXQgbmV3U3RhdGUsIG5ld1ZhbHVlO1xuXG4gICAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICAgICAgbmV3VmFsdWUgPSB2YWx1ZTtcblxuICAgICAgICAgICAgLy8gQWRkIHRvIHNlbGVjdGlvbiBpZiBub3QgeWV0IHNlbGVjdGVkXG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzVmFsdWUoYWRkVmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgbmV3VmFsdWUgPSB2YWx1ZS5jb25jYXQoW2FkZFZhbHVlXSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBVbnNlbGVjdCBpZiBtYW55IG9wdGlvbnMgYXJlIHNlbGVjdGVkXG4gICAgICAgICAgICAgICAgbmV3VmFsdWUuc3BsaWNlKFxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZS5pbmRleE9mKGFkZFZhbHVlKSxcbiAgICAgICAgICAgICAgICAgICAgMSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG5ld1N0YXRlID0ge1xuICAgICAgICAgICAgICAgIHZhbHVlOiBuZXdWYWx1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5ld1ZhbHVlID0gYWRkVmFsdWU7XG5cbiAgICAgICAgICAgIG5ld1N0YXRlID0ge1xuICAgICAgICAgICAgICAgIHZhbHVlOiAgYWRkVmFsdWUsXG4gICAgICAgICAgICAgICAgb3BlbmVkOiBmYWxzZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKG9uQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgb25DaGFuZ2UobmV3VmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogR2V0IGN1cnJlbnQgdmFsdWUgYXMgYSBzdHJpbmcgKGZvciBoaWRkZW4gaW5wdXQpXG4gICAgICogQHJldHVybiB7U3RyaW5nfVxuICAgICAqL1xuICAgIGdldFN0cmluZ1ZhbHVlKCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlLCByZW5kZXJUb1N0cmluZyB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMucHJvcHMubXVsdGlwbGUpIHtcbiAgICAgICAgICAgIHJldHVybiByZW5kZXJUb1N0cmluZyh2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgICAgICAgICAgICAubWFwKHJlbmRlclRvU3RyaW5nKVxuICAgICAgICAgICAgICAgIC5qb2luKHRoaXMucHJvcHMuZGVsaW1pdGVyKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBhIHZhbHVlIGlzIHNlbGVjdGVkXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlXG4gICAgICogQHJldHVybiB7Qm9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNWYWx1ZSh2YWx1ZSkge1xuICAgICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzLnN0YXRlLnZhbHVlO1xuXG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5tdWx0aXBsZSkge1xuICAgICAgICAgICAgcmV0dXJuIChjdXJyZW50VmFsdWUgPT09IHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAoY3VycmVudFZhbHVlLmluZGV4T2YodmFsdWUpID49IDApO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEZvY3VzIHRoZSBzZWFyY2ggaW5wdXRcbiAgICAgKi9cbiAgICBmb2N1c1NlYXJjaCgpIHtcbiAgICAgICAgY29uc3QgeyBzZWFyY2hJbnB1dCB9ID0gdGhpcy5yZWZzO1xuICAgICAgICBpZiAoIXNlYXJjaElucHV0KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzZWFyY2hJbnB1dC5mb2N1cygpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZW5kZXIgYnV0dG9uIHRvIG9wZW4gc2VsZWN0XG4gICAgICovXG4gICAgcmVuZGVyQnV0dG9uKCkge1xuICAgICAgICBsZXQgeyBkaXNhYmxlZCwgYmxvY2ssIG11bHRpcGxlLCBwbGFjZWhvbGRlciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgbGV0IHsgdmFsdWUsIG9wZW5lZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgbGV0IENvbXBvbmVudFNlbGVjdGlvbiA9IHRoaXMucHJvcHMuY29tcG9uZW50U2VsZWN0aW9uIHx8IHRoaXMucHJvcHMuY29tcG9uZW50O1xuXG4gICAgICAgIGxldCBpbm5lcjtcblxuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IG11bHRpcGxlPyB2YWx1ZSA6IFt2YWx1ZV07XG4gICAgICAgICAgICBpbm5lciAgICAgID0gKFxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIlNlbGVjdFNlbGVjdGlvbnNcIj5cbiAgICAgICAgICAgICAgICB7dmFsdWVzLm1hcChmdW5jdGlvbih2YWwsIGkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGtleT17aX0gY2xhc3NOYW1lPVwiU2VsZWN0U2VsZWN0aW9uXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPENvbXBvbmVudFNlbGVjdGlvbiBvcHRpb249e3ZhbH0gaW5kZXg9e2l9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSl9XG4gICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlubmVyID0gPHNwYW4gY2xhc3NOYW1lPVwiU2VsZWN0UGxhY2Vob2xkZXJcIj57cGxhY2Vob2xkZXJ9PC9zcGFuPjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QnV0dG9uIHNpemU9e3RoaXMucHJvcHMuc2l6ZX0gYmxvY2s9e2Jsb2NrfSBkaXNhYmxlZD17ZGlzYWJsZWR9IGFjdGl2ZT17b3BlbmVkfSBvbkNsaWNrPXt0aGlzLm9uVG9nZ2xlfT5cbiAgICAgICAgICAgICAgICB7aW5uZXJ9IDxCdXR0b24uQ2FyZXQgLz5cbiAgICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZW5kZXIgYnV0dG9uIHRvIG9wZW4gc2VsZWN0XG4gICAgICovXG4gICAgcmVuZGVyU2VhcmNoKCkge1xuICAgICAgICBsZXQgeyBxdWVyeSB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJTZWxlY3RTZWFyY2hcIj5cbiAgICAgICAgICAgICAgICA8SW5wdXQgcmVmPVwic2VhcmNoSW5wdXRcIlxuICAgICAgICAgICAgICAgICAgICB2YWx1ZT17cXVlcnl9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uU2VhcmNoQ2hhbmdlZH1cbiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9e3RoaXMucHJvcHMucGxhY2Vob2xkZXJ9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZW5kZXIgdGhlIG9wdGlvbnMgc2VsZWN0b3JcbiAgICAgKi9cbiAgICByZW5kZXJHcm91cChncm91cCwgaW5kZXgpIHtcbiAgICAgICAgY29uc3QgeyBxdWVyeSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBmaWx0ZXIgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGxldCBDb21wb25lbnQgPSB0aGlzLnByb3BzLmNvbXBvbmVudDtcbiAgICAgICAgbGV0IGNvdW50ICAgICA9IDA7XG5cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGdyb3VwLm9wdGlvbnMubWFwKGZ1bmN0aW9uKGl0ZW0sIGkpIHtcbiAgICAgICAgICAgIGlmICghZmlsdGVyKHF1ZXJ5LCBpdGVtLCBpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY291bnQrKztcblxuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgICAgIGtleT17aX1cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKCdTZWxlY3RPcHRpb24nLCB7IGFjdGl2ZTogdGhpcy5oYXNWYWx1ZShpdGVtKSB9KX1cbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17ZSA9PiB0aGlzLm9uVG9nZ2xlT3B0aW9uKGl0ZW0pfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPENvbXBvbmVudCBvcHRpb249e2l0ZW19IGluZGV4PXtpfSAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICAgICAgLy8gRG9uJ3QgZGlzcGxheSBlbXB0eSBncm91cHMgKHdoZW4gZmlsdGVyZWQpXG4gICAgICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYga2V5PXtpbmRleH0gY2xhc3NOYW1lPVwiU2VsZWN0T3B0R3JvdXBcIj5cbiAgICAgICAgICAgICAgICB7Z3JvdXAubGFiZWw/IDxkaXYgY2xhc3NOYW1lPVwiR3JvdXBMYWJlbFwiPntncm91cC5sYWJlbH08L2Rpdj4gOiAnJ31cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIkdyb3VwT3B0aW9uc1wiPlxuICAgICAgICAgICAgICAgICAgICB7b3B0aW9uc31cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZW5kZXIgdGhlIGdyb3Vwc1xuICAgICAqL1xuICAgIHJlbmRlckdyb3VwcygpIHtcbiAgICAgICAgY29uc3QgeyBvcGVuZWQsIGdyb3VwcyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBzZWFyY2ggfSA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgY29uc3QgY2xhc3NOYW1lID0gY2xhc3NOYW1lcygnU2VsZWN0Q29udGFpbmVyJywge1xuICAgICAgICAgICAgJ29wZW4nOiBvcGVuZWRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWV9PlxuICAgICAgICAgICAgICAgIHtzZWFyY2g/IHRoaXMucmVuZGVyU2VhcmNoKCkgOiAnJ31cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIlNlbGVjdEdyb3Vwc1wiPlxuICAgICAgICAgICAgICAgICAgICB7Z3JvdXBzLm1hcCh0aGlzLnJlbmRlckdyb3VwKX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGxldCB7IG5hbWUsIGJsb2NrIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IG9wZW5lZCB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBsZXQgY2xhc3NOYW1lID0gY2xhc3NOYW1lcygnU2VsZWN0Rm9ybUNvbnRyb2wnLCB7XG4gICAgICAgICAgICBibG9ja1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTmFtZX0gb25DbGljaz17ZSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpfT5cbiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT1cImhpZGRlblwiIG5hbWU9e25hbWV9IHZhbHVlPXt0aGlzLmdldFN0cmluZ1ZhbHVlKCl9IC8+XG4gICAgICAgICAgICAgICAge3RoaXMucmVuZGVyQnV0dG9uKCl9XG4gICAgICAgICAgICAgICAge29wZW5lZD8gPEJhY2tkcm9wIG9uQ2xvc2U9e3RoaXMuY2xvc2V9Pnt0aGlzLnJlbmRlckdyb3VwcygpfTwvQmFja2Ryb3A+IDogJyd9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBTZWxlY3Q7XG4iXX0=