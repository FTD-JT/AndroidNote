<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>Retrofit | Android常用学习资源</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="../net/volley.html" />
    
    
    <link rel="prev" href="../net/okhttp.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="13.3" data-basepath=".." data-revision="1437125288874">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> UI</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" >
            
            <span><b>1.1.</b> Layouts</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" >
            
            <span><b>1.2.</b> Components</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.2.1" data-path="ui/textview.html">
            
                
                    <a href="../ui/textview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.1.</b>
                        
                         TextView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.2" data-path="ui/webview.html">
            
                
                    <a href="../ui/webview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.2.</b>
                        
                         WebView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.3" data-path="ui/recyclerview.html">
            
                
                    <a href="../ui/recyclerview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.3.</b>
                        
                         RecyclerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.4" data-path="ui/fragmenttabhost.html">
            
                
                    <a href="../ui/fragmenttabhost.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.4.</b>
                        
                         FragmentTabHost
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.5" data-path="ui/viewpager.html">
            
                
                    <a href="../ui/viewpager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.5.</b>
                        
                         ViewPager
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.3" >
            
            <span><b>1.3.</b> AdapterView</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.3.1" data-path="ui/listview.html">
            
                
                    <a href="../ui/listview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.1.</b>
                        
                         ListView
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.4" >
            
            <span><b>1.4.</b> Adapter</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="ui/actionbar.html">
            
                
                    <a href="../ui/actionbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         ActionBar
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="ui/toast.html">
            
                
                    <a href="../ui/toast.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         Toast
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="ui/notification.html">
            
                
                    <a href="../ui/notification.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         Notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="ui/layoutinflater.html">
            
                
                    <a href="../ui/layoutinflater.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         LayoutInflater
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.9" data-path="ui/customview.html">
            
                
                    <a href="../ui/customview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         自定义View
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" >
            
            <span><b>1.10.</b> Resource</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.10.1" data-path="ui/drawable-resource.html">
            
                
                    <a href="../ui/drawable-resource.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.1.</b>
                        
                         DrawableResource
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Intent</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Activity</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="activity/Activity启动模式.html">
            
                
                    <a href="../activity/Activity启动模式.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Activity启动模式
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="activity/页面切换之间的数据传递.html">
            
                
                    <a href="../activity/页面切换之间的数据传递.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         数据传递
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" >
            
            <span><b>4.</b> Fragment</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="fragment/manager.html">
            
                
                    <a href="../fragment/manager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Fragment管理
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" >
            
            <span><b>5.</b> Service</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="get_androidmanifest_info.html">
            
                
                    <a href="../get_androidmanifest_info.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         获取AndroidManifest.xml信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" >
            
            <span><b>7.</b> [多线程]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="7.1" data-path="multithread/handler.html">
            
                
                    <a href="../multithread/handler.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                         Handler
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="8" >
            
            <span><b>8.</b> [存储]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="8.1" data-path="data/sharedpreferences.html">
            
                
                    <a href="../data/sharedpreferences.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.</b>
                        
                         SharedPreferences
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="9" >
            
            <span><b>9.</b> [数据库]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="9.1" data-path="database/SQLite.html">
            
                
                    <a href="../database/SQLite.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                         SQLite
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9.2" data-path="database/数据库操作.html">
            
                
                    <a href="../database/数据库操作.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                         数据库操作
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9.3" data-path="database/activeandroid.html">
            
                
                    <a href="../database/activeandroid.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                         ActiveAndroid
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="RxJava.html">
            
                
                    <a href="../RxJava.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         RxJava
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="MVVM.html">
            
                
                    <a href="../MVVM.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         MVVM
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="parse/gson.html">
            
                
                    <a href="../parse/gson.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         JSON解析
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" >
            
            <span><b>13.</b> 网络请求</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="13.1" data-path="net/httpurlconnection.html">
            
                
                    <a href="../net/httpurlconnection.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.1.</b>
                        
                         HttpURLConnection使用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.2" data-path="net/okhttp.html">
            
                
                    <a href="../net/okhttp.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.2.</b>
                        
                         OkHttp
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="13.3" data-path="net/retrofit.html">
            
                
                    <a href="../net/retrofit.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.3.</b>
                        
                         Retrofit
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.4" data-path="net/volley.html">
            
                
                    <a href="../net/volley.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.4.</b>
                        
                         Volley
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="14" >
            
            <span><b>14.</b> 网络图片加载</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="14.1" data-path="net/android-universal-image-loader.html">
            
                
                    <a href="../net/android-universal-image-loader.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.1.</b>
                        
                         Android-Universal-Image-Loader
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14.2" data-path="net/picasso.html">
            
                
                    <a href="../net/picasso.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.2.</b>
                        
                         Picasso
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="net/downloadprovider.html">
            
                
                    <a href="../net/downloadprovider.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         DownloadProvider
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" >
            
            <span><b>16.</b> 注解</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="16.1" data-path="annotation/butterknife.html">
            
                
                    <a href="../annotation/butterknife.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.1.</b>
                        
                         ButterKnife
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16.2" data-path="annotation/androidannotations.html">
            
                
                    <a href="../annotation/androidannotations.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.2.</b>
                        
                         AndroidAnnotations
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="17" >
            
            <span><b>17.</b> 工具</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="17.1" >
            
            <span><b>17.1.</b> AndroidStudio</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="17.1.1" data-path="tools/android-studio/tips_and_tricks.html">
            
                
                    <a href="../tools/android-studio/tips_and_tricks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.1.1.</b>
                        
                         提示和技巧
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17.1.2" data-path="tools/android-studio/question.html">
            
                
                    <a href="../tools/android-studio/question.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.1.2.</b>
                        
                         常见问题
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="17.2" data-path="tools/android-resource-remover.html">
            
                
                    <a href="../tools/android-resource-remover.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.2.</b>
                        
                         android-resource-remover
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Android常用学习资源</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_21">
                    
                        <h2 id="retrofit">Retrofit使用</h2>
<h3 id="">目录</h3>
<ul>
<li><a href="#1.介绍">1.介绍</a></li>
<li><a href="#2.使用">2.使用</a><ul>
<li><a href="#2.1.请求方法">2.1.请求方法</a></li>
<li><a href="#2.2.URL操作">2.2.URL操作</a></li>
<li><a href="#2.3.发送原生数据">2.3.发送原生数据</a></li>
<li><a href="#2.4.表单提交和文件上传">2.4.表单提交和文件上传</a></li>
<li><a href="#2.5.请求头">2.5.请求头</a></li>
<li><a href="#2.6.同步和异步加载">2.6.同步和异步加载</a></li>
<li><a href="#2.7.返回数据类型">2.7.返回数据类型</a></li>
</ul>
</li>
<li><a href="#3.RestAdapter配置">3.RestAdapter配置</a><ul>
<li><a href="#3.1.设置自定义转换器">3.1.设置自定义转换器</a></li>
<li><a href="#3.2.自定义错误处理">3.2.自定义错误处理</a></li>
<li><a href="#3.3.设置Log">3.3.设置Log</a></li>
</ul>
</li>
<li><a href="#4.Retrofit源码分析">4.Retrofit源码分析</a><ul>
<li><a href="#4.1RestAdapter配置分析">4.1RestAdapter配置分析</a></li>
<li><a href="#4.2解析请求方法">4.2解析请求方法</a></li>
<li><a href="#4.3构建请求">4.3构建请求</a></li>
<li><a href="#4.4发送请求">4.4发送请求</a></li>
</ul>
</li>
<li><a href="#参考">参考</a></li>
</ul>
<hr>
<h3 id="1.介绍">1.介绍</h3>

<p><a href="http://square.github.io/retrofit/" target="_blank">Retrofit</a> 是一个类型安全的Java <a href="http://zh.wikipedia.org/wiki/REST" target="_blank">Rest</a> 客户端，而且也适用于Android。</p>
<p><a href="http://square.github.io/retrofit/" target="_blank">Retrofit</a>可以将Rest Api转换为Java的接口。</p>
<pre><code class="lang-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GitHubService</span> </span>{
  <span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/{user}/repos"</span>)
  <span class="hljs-function">List&lt;Repo&gt; <span class="hljs-title">listRepos</span><span class="hljs-params">(@Path(<span class="hljs-string">"user"</span>)</span> String user)</span>;
}
</code></pre>
<p>通过RestAdapter类，可以创建GithubService的实例。</p>
<pre><code class="lang-java">RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setEndpoint(<span class="hljs-string">"https://api.github.com"</span>)
    .build();

GitHubService service = restAdapter.create(GitHubService.class);
</code></pre>
<p>接着就可以调用创建的GithubService的方法进行网络请求。</p>
<pre><code class="lang-java">List&lt;Repo&gt; repos = service.listRepos(<span class="hljs-string">"octocat"</span>);
</code></pre>
<h3 id="2.使用">2.使用</h3>


<h4 id="2.1.请求方法">2.1.请求方法</h4>

<p>每一个方法必须有HTTP注解和关联的URL。Retrofit提供了五种内置的注解：<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>DELETE</code>,<code>HEAD</code>。在注解内指定相关的URL和资源。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
</code></pre>
<p>也可以在URL中指定查询参数。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list?sort=desc"</span>)
</code></pre>
<h4 id="2.2.URL操作">2.2.URL操作</h4>


<p>通过动态的使用替换块和参数可以更新请求的URL。替换块是一个被<code>{</code>和<code>}</code>包裹的字符串。相应的请求参数必须被<code>@Path</code>使用相同的字符串进行注解。</p>
<pre><code class="lang-java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/group/{id}/users"</span>)
<span class="hljs-function">List&lt;User&gt; <span class="hljs-title">groupList</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> groupId)</span>;
</code></pre>
<p>也可以添加查询参数。</p>
<pre><code class="lang-java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/group/{id}/users"</span>)
<span class="hljs-function">List&lt;User&gt; <span class="hljs-title">groupList</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> groupId, @<span class="hljs-title">Query</span><span class="hljs-params">(<span class="hljs-string">"sort"</span>)</span> String sort)</span>;
</code></pre>
<p>复杂的查询参数组合可以使用一个<code>map</code></p>
<pre><code class="lang-java">
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/group/{id}/users"</span>)
<span class="hljs-function">List&lt;User&gt; <span class="hljs-title">groupList</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> groupId, @QueryMap Map&lt;String, String&gt; options)</span>;
</code></pre>
<h4 id="2.3.发送原生数据">2.3.发送原生数据</h4>

<p>当你的请求参数是如下JSON字符串，可以使用<code>@Body</code>注解一个对象，<code>Retrofit</code>可以将对象转换为字符串</p>
<pre><code>{&quot;foo&quot;:&quot;kit&quot;,&quot;bar&quot;:&quot;kat&quot;}
</code></pre><p>定义对象</p>
<pre><code class="lang-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FooRequest</span> </span>{
  <span class="hljs-keyword">final</span> String foo;
  <span class="hljs-keyword">final</span> String bar;

  FooRequest(String foo, String bar) {
    <span class="hljs-keyword">this</span>.foo = foo;
    <span class="hljs-keyword">this</span>.bar = bar;
  }
}
</code></pre>
<p>使用<code>@Body</code></p>
<pre><code class="lang-java"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-annotation">@POST</span>(<span class="hljs-string">"/jayson"</span>)
  <span class="hljs-function">FooResponse <span class="hljs-title">postJson</span><span class="hljs-params">(@Body FooRequest body)</span></span>;
}
</code></pre>
<p>如果你想直接发送一个JSON串，可以使用 <code>TypedByteArray</code>。</p>
<pre><code class="lang-java">
String json = <span class="hljs-string">"{\"foo\":\"kit\",\"bar\":\"kat\"}"</span>;
TypedInput in = <span class="hljs-keyword">new</span> TypedByteArray(<span class="hljs-string">"application/json"</span>, json.getBytes(<span class="hljs-string">"UTF-8"</span>));
FooResponse response = foo.postRawJson(in);
</code></pre>
<h4 id="2.4.表单提交和文件上传">2.4.表单提交和文件上传</h4>



<p>使用<code>@FormUrlEncoded</code>可以进行表单提交。每一个包含名字和提供数据对象的键值对需要使用<code>@Field</code>进行注解。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@FormUrlEncoded</span>
<span class="hljs-annotation">@POST</span>(<span class="hljs-string">"/user/edit"</span>)
<span class="hljs-function">User <span class="hljs-title">updateUser</span><span class="hljs-params">(@Field(<span class="hljs-string">"first_name"</span>)</span> String first, @<span class="hljs-title">Field</span><span class="hljs-params">(<span class="hljs-string">"last_name"</span>)</span> String last)</span>;
</code></pre>
<p>使用<code>@Multipart</code>注解，可以进行文件上传。<code>Parts</code>使用<code>@Part</code>进行注解。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@Multipart</span>
<span class="hljs-annotation">@PUT</span>(<span class="hljs-string">"/user/photo"</span>)
<span class="hljs-function">User <span class="hljs-title">updateUser</span><span class="hljs-params">(@Part(<span class="hljs-string">"photo"</span>)</span> TypedFile photo, @<span class="hljs-title">Part</span><span class="hljs-params">(<span class="hljs-string">"description"</span>)</span> TypedString description)</span>;
</code></pre>
<h4 id="2.5.请求头">2.5.请求头</h4>

<p>可以使用<code>@Headers</code>注解为方法设置一个请求头。</p>
<pre><code class="lang-java"><span class="hljs-annotation">@Headers</span>(<span class="hljs-string">"Cache-Control: max-age=640000"</span>)
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/widget/list"</span>)
<span class="hljs-function">List&lt;Widget&gt; <span class="hljs-title">widgetList</span><span class="hljs-params">()</span></span>;
</code></pre>
<p>添加多个请求头</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@Headers</span>({
    <span class="hljs-string">"Accept: application/vnd.github.v3.full+json"</span>,
    <span class="hljs-string">"User-Agent: Retrofit-Sample-App"</span>
})
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/{username}"</span>)
<span class="hljs-function">User <span class="hljs-title">getUser</span><span class="hljs-params">(@Path(<span class="hljs-string">"username"</span>)</span> String username)</span>;
</code></pre>
<p>请求头不会被互相覆盖，所有拥有相同名字的请求头都会被包含在请求里。</p>
<p>一个请求头可以使用<code>@Header</code>注解动态的更新，并且必须为<code>@Header</code>提供一个相应的字符串参数。如果值为空，请求头将被忽略。</p>
<pre><code class="lang-java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/user"</span>)
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getUser</span><span class="hljs-params">(@Header(<span class="hljs-string">"Authorization"</span>)</span> String authorization, Callback&lt;User&gt; callback)</span>
</code></pre>
<p>如果请求头需要被添加到所有的请求中，可以使用一个RequestInterceptor进行指定。在下面的代码中创建了一个<code>RequestInterceptor</code>，它为每一个请求都添加了一个<code>User-Agent</code>请求头。</p>
<pre><code class="lang-java">RequestInterceptor requestInterceptor = <span class="hljs-keyword">new</span> RequestInterceptor() {
  <span class="hljs-annotation">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">intercept</span><span class="hljs-params">(RequestFacade request)</span> </span>{
    request.addHeader(<span class="hljs-string">"User-Agent"</span>, <span class="hljs-string">"Retrofit-Sample-App"</span>);
  }
};

RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
  .setEndpoint(<span class="hljs-string">"https://api.github.com"</span>)
  .setRequestInterceptor(requestInterceptor)
  .build();
</code></pre>
<h4 id="2.6.同步和异步加载">2.6.同步和异步加载</h4>


<p>可以声明方法是同步执行还是异步执行。</p>
<p>带有返回值类型的方法将被同步执行。</p>
<pre><code class="lang-java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/user/{id}/photo"</span>)
<span class="hljs-function">Photo <span class="hljs-title">getUserPhoto</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> id)</span>;
</code></pre>
<p>异步执行要求方法的最后一个参数是<code>Callback</code>，反省类型为请求的返回值，如果没有返回值或者不需要对返回值进行处理可以设置成<code>Callback&lt;Void&gt;</code></p>
<pre><code class="lang-java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/user/{id}/photo"</span>)
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getUserPhoto</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> id, Callback&lt;Photo&gt; cb)</span>;
</code></pre>
<p>在android中，<code>callbacks</code>在主线程中被执行。对于桌面应用，回调和执行HTTP请求在同一线程中。</p>
<p>Retrofit集成了RxJava，允许方法返回一个<code>rx.Observable</code>类型。</p>
<pre><code class="lang-Java"><span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/user/{id}/photo"</span>)
<span class="hljs-function">Observable&lt;Photo&gt; <span class="hljs-title">getUserPhoto</span><span class="hljs-params">(@Path(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">int</span> id)</span>;
</code></pre>
<p>Observable请求被异步的订阅并且在执行HTTP请求的线程中被观察。如果希望在不同的线程中观察，调用<code>observeOn(Scheduler)</code>返回<code>Observable</code>。</p>
<h4 id="2.7.返回数据类型">2.7.返回数据类型</h4>

<p>如果你的接口返回的是JSON数据类型，<code>RestAdapter</code>会自动转换为方法声明的或者CallBack和Observable中指定的对象。如果是XML或其它数据类型，则需要自定义<code>RestAdapter</code>转换器。关于如何自定义<code>RestAdapter</code>转换器，将在下面的文章中讲到。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
<span class="hljs-function">List&lt;User&gt; <span class="hljs-title">userList</span><span class="hljs-params">()</span></span>;

<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">userList</span><span class="hljs-params">(Callback&lt;List&lt;User&gt;&gt; cb)</span></span>;

<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
Observable&lt;List&lt;User&gt;&gt; userList();
</code></pre>
<p>如果不希望返回值被处理成指定的类型，则可以通过在方法返回值声明、CallBack以及Observable中使用<code>Response</code>对象来实现。</p>
<pre><code class="lang-java">
<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
<span class="hljs-function">Response <span class="hljs-title">userList</span><span class="hljs-params">()</span></span>;

<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">userList</span><span class="hljs-params">(Callback&lt;Response&gt; cb)</span></span>;

<span class="hljs-annotation">@GET</span>(<span class="hljs-string">"/users/list"</span>)
<span class="hljs-function">Observable&lt;Response&gt; <span class="hljs-title">userList</span><span class="hljs-params">()</span></span>;
</code></pre>
<h3 id="3.RestAdapter配置">3.RestAdapter配置</h3>

<p>除了使用Retrofit提供的默认RestAdapter以外，我们还可以进行设置转换器和设置客户端等自定义操作</p>
<h4 id="3.1.设置自定义转换器">3.1.设置自定义转换器</h4>


<p>Retrofit使用未进行任何配置的GSON来转换数据，如果希望使用经过GsonBuilder配置过的Gson，需要创建一个新的GsonConvert。</p>
<pre><code class="lang-java">
Gson gson = <span class="hljs-keyword">new</span> GsonBuilder()
    .setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES)
    .registerTypeAdapter(Date.class, <span class="hljs-keyword">new</span> DateTypeAdapter())
    .create();

RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setEndpoint(<span class="hljs-string">"https://api.github.com"</span>)
    .setConverter(<span class="hljs-keyword">new</span> GsonConverter(gson))
    .build();

GitHubService service = restAdapter.create(GitHubService.class);
</code></pre>
<p>如果请求返回值是XML或者<code>Protocol Buffers</code>格式，Retrofit也提供了XML和<code>Protocol Buffers</code>格式的转换器。</p>
<p>下面的代码演示了如何使用<code>SimpleXMLConvert</code>。</p>
<pre><code class="lang-java">RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setEndpoint(<span class="hljs-string">"https://api.soundcloud.com"</span>)
    .setConverter(<span class="hljs-keyword">new</span> SimpleXMLConverter())
    .build();

SoundCloudService service = restAdapter.create(SoundCloudService.class);
</code></pre>
<p><code>ProtoConverter</code>使用</p>
<pre><code class="lang-java">
RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setEndpoint(<span class="hljs-string">"https://api.example.com"</span>)
    .setConverter(<span class="hljs-keyword">new</span> ProtoConverter())
    .build();
</code></pre>
<p>如果你需要使用Retrofit不提供的内容格式来进行数据交换或者你想使用其他的库来转换已经存在的格式，可以通过实现Convert接口创建自己的转换器。</p>
<h4 id="3.2.自定义错误处理">3.2.自定义错误处理</h4>



<p>提供自定义的<code>ErrorHandler</code>可以自定义错误处理，下面的代码中演示了当返回401如何抛出一个自定义异常。</p>
<pre><code class="lang-java">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyErrorHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ErrorHandler</span> </span>{
  <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> Throwable <span class="hljs-title">handleError</span><span class="hljs-params">(RetrofitError cause)</span> </span>{
    Response r = cause.getResponse();
    <span class="hljs-keyword">if</span> (r != <span class="hljs-keyword">null</span> &amp;&amp; r.getStatus() == <span class="hljs-number">401</span>) {
      <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">UnauthorizedException</span><span class="hljs-params">(cause)</span></span>;
    }
    <span class="hljs-keyword">return</span> cause;
  }
}

RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setEndpoint(<span class="hljs-string">"https://api.github.com"</span>)
    .setErrorHandler(<span class="hljs-keyword">new</span> MyErrorHandler())
    .build();
</code></pre>
<h4 id="3.3.设置Log">3.3.设置Log</h4>

<p><code>RestAdapter</code>可以通过setLogLevel方法配置Log的级别，打印不同的Log信息。Retrofit提供了<code>BASIC</code>,<code>FULL</code>,<code>HEADERS</code>和<code>NONE</code>等四种Log过滤条件。</p>
<pre><code class="lang-java">
RestAdapter restAdapter = <span class="hljs-keyword">new</span> RestAdapter.Builder()
    .setLogLevel(RestAdapter.LogLevel.FULL)
    .setEndpoint(<span class="hljs-string">"https://api.github.com"</span>)
    .build();
</code></pre>
<h3 id="4.Retrofit源码分析">4.Retrofit源码分析</h3>

<h4 id="4.1RestAdapter配置分析">4.1RestAdapter配置分析</h4>

<p>我们先从<code>RestAdapter</code>的<code>build()</code>方法入手，当不设置某些配置时，就会获取默认的配置。</p>
<pre><code class="lang-java">
   <span class="hljs-javadoc">/** Create the {@link RestAdapter} instances. */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestAdapter <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (endpoint == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Endpoint may not be null."</span>);
      }
      ensureSaneDefaults();
      <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">RestAdapter</span><span class="hljs-params">(endpoint, clientProvider, httpExecutor, callbackExecutor,
          requestInterceptor, converter, profiler, errorHandler, log, logLevel)</span></span>;
    }

  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ensureSaneDefaults</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (converter == <span class="hljs-keyword">null</span>) {
        converter = Platform.get().defaultConverter();
      }
      <span class="hljs-keyword">if</span> (clientProvider == <span class="hljs-keyword">null</span>) {
        clientProvider = Platform.get().defaultClient();
      }
      <span class="hljs-keyword">if</span> (httpExecutor == <span class="hljs-keyword">null</span>) {
        httpExecutor = Platform.get().defaultHttpExecutor();
      }
      <span class="hljs-keyword">if</span> (callbackExecutor == <span class="hljs-keyword">null</span>) {
        callbackExecutor = Platform.get().defaultCallbackExecutor();
      }
      <span class="hljs-keyword">if</span> (errorHandler == <span class="hljs-keyword">null</span>) {
        errorHandler = ErrorHandler.DEFAULT;
      }
      <span class="hljs-keyword">if</span> (log == <span class="hljs-keyword">null</span>) {
        log = Platform.get().defaultLog();
      }
      <span class="hljs-keyword">if</span> (requestInterceptor == <span class="hljs-keyword">null</span>) {
        requestInterceptor = RequestInterceptor.NONE;
      }
    }
</code></pre>
<pre><code class="lang-java"> <span class="hljs-javadoc">/** Provides sane defaults for operation on Android. */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Android</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Platform</span> </span>{
    <span class="hljs-annotation">@Override</span> <span class="hljs-function">Converter <span class="hljs-title">defaultConverter</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">GsonConverter</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Gson()</span>)</span>;
    }

    <span class="hljs-annotation">@Override</span> Client.<span class="hljs-function">Provider <span class="hljs-title">defaultClient</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">final</span> Client client;
      <span class="hljs-keyword">if</span> (hasOkHttpOnClasspath()) {
        client = OkClientInstantiator.instantiate();
      } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.GINGERBREAD)</span> </span>{
        client = <span class="hljs-keyword">new</span> AndroidApacheClient();
      } <span class="hljs-keyword">else</span> {
        client = <span class="hljs-keyword">new</span> UrlConnectionClient();
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Client.Provider() {
        <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> Client <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> client;
        }
      };
    }

    <span class="hljs-annotation">@Override</span> <span class="hljs-function">Executor <span class="hljs-title">defaultHttpExecutor</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> Executors.newCachedThreadPool(<span class="hljs-keyword">new</span> ThreadFactory() {
        <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> Thread <span class="hljs-title">newThread</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Runnable r)</span> </span>{
          <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Runnable()</span> </span>{
            <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
              Process.setThreadPriority(THREAD_PRIORITY_BACKGROUND);
              r.run();
            }
          }, RestAdapter.IDLE_THREAD_NAME);
        }
      });
    }

    <span class="hljs-annotation">@Override</span> <span class="hljs-function">Executor <span class="hljs-title">defaultCallbackExecutor</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">MainThreadExecutor</span><span class="hljs-params">()</span></span>;
    }

    <span class="hljs-annotation">@Override</span> RestAdapter.<span class="hljs-function">Log <span class="hljs-title">defaultLog</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">AndroidLog</span><span class="hljs-params">(<span class="hljs-string">"Retrofit"</span>)</span></span>;
    }
  }
</code></pre>
<p>接下来看<code>RestAdapter</code>的<code>create</code>方法。</p>
<pre><code class="lang-java">  <span class="hljs-javadoc">/** Create an implementation of the API defined by the specified {@code service} interface. */</span>
  <span class="hljs-annotation">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">create</span><span class="hljs-params">(Class&lt;T&gt; service)</span> </span>{
    Utils.validateServiceClass(service);
    <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { service },
        <span class="hljs-keyword">new</span> RestHandler(getMethodInfoCache(service)));
  }
</code></pre>
<p><code>create</code>方法创建了一个代理</p>
<pre><code class="lang-java"> <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>{

...
    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, <span class="hljs-keyword">final</span> Object[] args)</span>
        <span class="hljs-keyword">throws</span> Throwable </span>{

      <span class="hljs-comment">// Load or create the details cache for the current method.</span>
      <span class="hljs-keyword">final</span> RestMethodInfo methodInfo = getMethodInfo(methodDetailsCache, method);

      <span class="hljs-keyword">if</span> (methodInfo.isSynchronous) {
        <span class="hljs-keyword">try</span> {
         <span class="hljs-comment">//调用请求</span>
          <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">invokeRequest</span><span class="hljs-params">(requestInterceptor, methodInfo, args)</span></span>;
        } <span class="hljs-keyword">catch</span> (RetrofitError error) {
          Throwable newError = errorHandler.handleError(error);
          <span class="hljs-keyword">if</span> (newError == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Error handler returned null for wrapped exception."</span>,
                error);
          }
          <span class="hljs-keyword">throw</span> newError;
        }
      }
      ...

 }
</code></pre>
<h4 id="4.2解析请求方法">4.2解析请求方法</h4>

<p><code>RestMethodInfo</code>用来封装网络请求方法的信息。</p>
<p><code>parseResponseType</code>方法获取返回值类型。</p>
<pre><code class="lang-java"> <span class="hljs-javadoc">/** Loads {@link #responseObjectType}. Returns {@code true} if method is synchronous. */</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> ResponseType <span class="hljs-title">parseResponseType</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Synchronous methods have a non-void return type.</span>
    <span class="hljs-comment">// Observable methods have a return type of Observable.</span>
    Type returnType = method.getGenericReturnType();

    <span class="hljs-comment">// Asynchronous methods should have a Callback type as the last argument.</span>
    Type lastArgType = <span class="hljs-keyword">null</span>;
    <span class="hljs-comment">// 最后一个参数</span>
    Class&lt;?&gt; lastArgClass = <span class="hljs-keyword">null</span>;
    Type[] parameterTypes = method.getGenericParameterTypes();
    <span class="hljs-keyword">if</span> (parameterTypes.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 获取最后一个参数</span>
      Type typeToCheck = parameterTypes[parameterTypes.length - <span class="hljs-number">1</span>];
      lastArgType = typeToCheck;
      <span class="hljs-keyword">if</span> (typeToCheck <span class="hljs-keyword">instanceof</span> ParameterizedType) {
        typeToCheck = ((ParameterizedType) typeToCheck).getRawType();
      }
      <span class="hljs-keyword">if</span> (typeToCheck <span class="hljs-keyword">instanceof</span> Class) {
        lastArgClass = (Class&lt;?&gt;) typeToCheck;
      }
    }

    <span class="hljs-keyword">boolean</span> hasReturnType = returnType != <span class="hljs-keyword">void</span>.class;
    <span class="hljs-keyword">boolean</span> hasCallback = lastArgClass != <span class="hljs-keyword">null</span> &amp;&amp; Callback.class.isAssignableFrom(lastArgClass);

    <span class="hljs-comment">// Check for invalid configurations.</span>
    <span class="hljs-keyword">if</span> (hasReturnType &amp;&amp; hasCallback) {
      <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Must have return type or Callback as last argument, not both."</span>);
    }
    <span class="hljs-keyword">if</span> (!hasReturnType &amp;&amp; !hasCallback) {
      <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Must have either a return type or Callback as last argument."</span>);
    }
    <span class="hljs-comment">// 如果有返回值类型</span>
    <span class="hljs-keyword">if</span> (hasReturnType) {
      <span class="hljs-keyword">if</span> (Platform.HAS_RX_JAVA) {
        Class rawReturnType = Types.getRawType(returnType);
        <span class="hljs-keyword">if</span> (RxSupport.isObservable(rawReturnType)) {
          returnType = RxSupport.getObservableType(returnType, rawReturnType);
          responseObjectType = getParameterUpperBound((ParameterizedType) returnType);
          <span class="hljs-keyword">return</span> ResponseType.OBSERVABLE;
        }
      }
      responseObjectType = returnType;
      <span class="hljs-keyword">return</span> ResponseType.OBJECT;
    }

    lastArgType = Types.getSupertype(lastArgType, Types.getRawType(lastArgType), Callback.class);
    <span class="hljs-keyword">if</span> (lastArgType <span class="hljs-keyword">instanceof</span> ParameterizedType) {
      responseObjectType = getParameterUpperBound((ParameterizedType) lastArgType);
      <span class="hljs-keyword">return</span> ResponseType.VOID;
    }

    <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Last parameter must be of type Callback&lt;X&gt; or Callback&lt;? super X&gt;."</span>);
  }
</code></pre>
<pre><code class="lang-java"><span class="hljs-javadoc">/** Loads {@link #requestMethod} and {@link #requestType}. */</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseMethodAnnotations</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (Annotation methodAnnotation : method.getAnnotations()) {
      Class&lt;? extends Annotation&gt; annotationType = methodAnnotation.annotationType();
      RestMethod methodInfo = <span class="hljs-keyword">null</span>;

      <span class="hljs-comment">// Look for a @RestMethod annotation on the parameter annotation indicating request method.</span>
      <span class="hljs-comment">// 获取RestMethod注解</span>
      <span class="hljs-keyword">for</span> (Annotation innerAnnotation : annotationType.getAnnotations()) {
        <span class="hljs-keyword">if</span> (RestMethod.class == innerAnnotation.annotationType()) {
          methodInfo = (RestMethod) innerAnnotation;
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-keyword">if</span> (methodInfo != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">if</span> (requestMethod != <span class="hljs-keyword">null</span>) {
          <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Only one HTTP method is allowed. Found: %s and %s."</span>, requestMethod,
              methodInfo.value());
        }
        String path;
        <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 获取路径</span>
          path = (String) annotationType.getMethod(<span class="hljs-string">"value"</span>).invoke(methodAnnotation);
        } <span class="hljs-keyword">catch</span> (Exception e) {
          <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Failed to extract String 'value' from @%s annotation."</span>,
              annotationType.getSimpleName());
        }
        parsePath(path);
        requestMethod = methodInfo.value();
        requestHasBody = methodInfo.hasBody();
      } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(annotationType == Headers.class)</span> </span>{
        String[] headersToParse = ((Headers) methodAnnotation).value();
        <span class="hljs-keyword">if</span> (headersToParse.length == <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"@Headers annotation is empty."</span>);
        }
        headers = parseHeaders(headersToParse);
      } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(annotationType == Multipart.class)</span> </span>{
        <span class="hljs-keyword">if</span> (requestType != RequestType.SIMPLE) {
          <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Only one encoding annotation is allowed."</span>);
        }
        requestType = RequestType.MULTIPART;
      } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(annotationType == FormUrlEncoded.class)</span> </span>{
        <span class="hljs-keyword">if</span> (requestType != RequestType.SIMPLE) {
          <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"Only one encoding annotation is allowed."</span>);
        }
        requestType = RequestType.FORM_URL_ENCODED;
      } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(annotationType == Streaming.class)</span> </span>{
        <span class="hljs-keyword">if</span> (responseObjectType != Response.class) {
          <span class="hljs-keyword">throw</span> methodError(
              <span class="hljs-string">"Only methods having %s as data type are allowed to have @%s annotation."</span>,
              Response.class.getSimpleName(), Streaming.class.getSimpleName());
        }
        isStreaming = <span class="hljs-keyword">true</span>;
      }
    }

    <span class="hljs-keyword">if</span> (requestMethod == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span>);
    }
    <span class="hljs-keyword">if</span> (!requestHasBody) {
      <span class="hljs-keyword">if</span> (requestType == RequestType.MULTIPART) {
        <span class="hljs-keyword">throw</span> methodError(
            <span class="hljs-string">"Multipart can only be specified on HTTP methods with request body (e.g., @POST)."</span>);
      }
      <span class="hljs-keyword">if</span> (requestType == RequestType.FORM_URL_ENCODED) {
        <span class="hljs-keyword">throw</span> methodError(<span class="hljs-string">"FormUrlEncoded can only be specified on HTTP methods with request body "</span>
                + <span class="hljs-string">"(e.g., @POST)."</span>);
      }
    }
  }
</code></pre>
<h4 id="4.3构建请求">4.3构建请求</h4>

<h4 id="4.4发送请求">4.4发送请求</h4>

<pre><code class="lang-java">
 <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">invokeRequest</span><span class="hljs-params">(RequestInterceptor requestInterceptor, RestMethodInfo methodInfo,
        Object[] args)</span> </span>{
      String url = <span class="hljs-keyword">null</span>;
      <span class="hljs-keyword">try</span> {
       ...
       <span class="hljs-comment">//构建请求</span>
        RequestBuilder requestBuilder = <span class="hljs-keyword">new</span> RequestBuilder(serverUrl, methodInfo, converter);
        requestBuilder.setArguments(args);
        requestInterceptor.intercept(requestBuilder);
        Request request = requestBuilder.build();
       ...
       <span class="hljs-comment">//请求网络</span>
        Response response = clientProvider.get().execute(request);


        <span class="hljs-keyword">int</span> statusCode = response.getStatus();
        <span class="hljs-keyword">if</span> (profiler != <span class="hljs-keyword">null</span>) {
          RequestInformation requestInfo = getRequestInfo(serverUrl, methodInfo, request);
          <span class="hljs-comment">//noinspection unchecked</span>
          profiler.afterCall(requestInfo, elapsedTime, statusCode, profilerObject);
        }

        <span class="hljs-keyword">if</span> (logLevel.log()) {
          <span class="hljs-comment">// Log the response data.</span>
          response = logAndReplaceResponse(url, response, elapsedTime);
        }

        Type type = methodInfo.responseObjectType;

        <span class="hljs-keyword">if</span> (statusCode &gt;= <span class="hljs-number">200</span> &amp;&amp; statusCode &lt; <span class="hljs-number">300</span>) { <span class="hljs-comment">// 2XX == successful request</span>
          <span class="hljs-comment">// Caller requested the raw Response object directly.</span>
          <span class="hljs-keyword">if</span> (type.equals(Response.class)) {
            <span class="hljs-keyword">if</span> (!methodInfo.isStreaming) {
              <span class="hljs-comment">// Read the entire stream and replace with one backed by a byte[].</span>
              response = Utils.readBodyToBytesIfNecessary(response);
            }

            <span class="hljs-keyword">if</span> (methodInfo.isSynchronous) {
              <span class="hljs-keyword">return</span> response;
            }
            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ResponseWrapper</span><span class="hljs-params">(response, response)</span></span>;
          }

          TypedInput body = response.getBody();
          <span class="hljs-keyword">if</span> (body == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">if</span> (methodInfo.isSynchronous) {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ResponseWrapper</span><span class="hljs-params">(response, <span class="hljs-keyword">null</span>)</span></span>;
          }

          ExceptionCatchingTypedInput wrapped = <span class="hljs-keyword">new</span> ExceptionCatchingTypedInput(body);
          <span class="hljs-keyword">try</span> {
            Object convert = converter.fromBody(wrapped, type);
            logResponseBody(body, convert);
            <span class="hljs-keyword">if</span> (methodInfo.isSynchronous) {
              <span class="hljs-keyword">return</span> convert;
            }
            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ResponseWrapper</span><span class="hljs-params">(response, convert)</span></span>;
          } <span class="hljs-keyword">catch</span> (ConversionException e) {
            <span class="hljs-comment">// If the underlying input stream threw an exception, propagate that rather than</span>
            <span class="hljs-comment">// indicating that it was a conversion exception.</span>
            <span class="hljs-keyword">if</span> (wrapped.threwException()) {
              <span class="hljs-keyword">throw</span> wrapped.getThrownException();
            }

            <span class="hljs-comment">// The response body was partially read by the converter. Replace it with null.</span>
            response = Utils.replaceResponseBody(response, <span class="hljs-keyword">null</span>);

            <span class="hljs-keyword">throw</span> RetrofitError.conversionError(url, response, converter, type, e);
          }
        }

        response = Utils.readBodyToBytesIfNecessary(response);
        <span class="hljs-keyword">throw</span> RetrofitError.httpError(url, response, converter, type);
      } <span class="hljs-keyword">catch</span> (RetrofitError e) {
        <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// Pass through our own errors.</span>
      } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">if</span> (logLevel.log()) {
          logException(e, url);
        }
        <span class="hljs-keyword">throw</span> RetrofitError.networkError(url, e);
      } <span class="hljs-keyword">catch</span> (Throwable t) {
        <span class="hljs-keyword">if</span> (logLevel.log()) {
          logException(t, url);
        }
        <span class="hljs-keyword">throw</span> RetrofitError.unexpectedError(url, t);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (!methodInfo.isSynchronous) {
          Thread.currentThread().setName(IDLE_THREAD_NAME);
        }
      }
    }
  }
</code></pre>
<pre><code class="lang-java"><span class="hljs-javadoc">/** Retrofit client that uses {@link HttpURLConnection} for communication. */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UrlConnectionClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Client</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CHUNK_SIZE = <span class="hljs-number">4096</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UrlConnectionClient</span><span class="hljs-params">()</span> </span>{
  }

  <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">execute</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException </span>{
    HttpURLConnection connection = openConnection(request);
    prepareRequest(connection, request);
    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">readResponse</span><span class="hljs-params">(connection)</span></span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">protected</span> HttpURLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException </span>{
    HttpURLConnection connection =
        (HttpURLConnection) <span class="hljs-keyword">new</span> URL(request.getUrl()).openConnection();
    connection.setConnectTimeout(Defaults.CONNECT_TIMEOUT_MILLIS);
    connection.setReadTimeout(Defaults.READ_TIMEOUT_MILLIS);
    <span class="hljs-keyword">return</span> connection;
  }

  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">prepareRequest</span><span class="hljs-params">(HttpURLConnection connection, Request request)</span> <span class="hljs-keyword">throws</span> IOException </span>{
    connection.setRequestMethod(request.getMethod());
    connection.setDoInput(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">for</span> (Header header : request.getHeaders()) {
      connection.addRequestProperty(header.getName(), header.getValue());
    }

    TypedOutput body = request.getBody();
    <span class="hljs-keyword">if</span> (body != <span class="hljs-keyword">null</span>) {
      connection.setDoOutput(<span class="hljs-keyword">true</span>);
      connection.addRequestProperty(<span class="hljs-string">"Content-Type"</span>, body.mimeType());
      <span class="hljs-keyword">long</span> length = body.length();
      <span class="hljs-keyword">if</span> (length != -<span class="hljs-number">1</span>) {
        connection.setFixedLengthStreamingMode((<span class="hljs-keyword">int</span>) length);
        connection.addRequestProperty(<span class="hljs-string">"Content-Length"</span>, String.valueOf(length));
      } <span class="hljs-keyword">else</span> {
        connection.setChunkedStreamingMode(CHUNK_SIZE);
      }
      body.writeTo(connection.getOutputStream());
    }
  }

  <span class="hljs-function">Response <span class="hljs-title">readResponse</span><span class="hljs-params">(HttpURLConnection connection)</span> <span class="hljs-keyword">throws</span> IOException </span>{
    <span class="hljs-keyword">int</span> status = connection.getResponseCode();
    String reason = connection.getResponseMessage();
    <span class="hljs-keyword">if</span> (reason == <span class="hljs-keyword">null</span>) reason = <span class="hljs-string">""</span>; <span class="hljs-comment">// HttpURLConnection treats empty reason as null.</span>

    List&lt;Header&gt; headers = <span class="hljs-keyword">new</span> ArrayList&lt;Header&gt;();
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; field : connection.getHeaderFields().entrySet()) {
      String name = field.getKey();
      <span class="hljs-keyword">for</span> (String value : field.getValue()) {
        headers.add(<span class="hljs-keyword">new</span> Header(name, value));
      }
    }

    String mimeType = connection.getContentType();
    <span class="hljs-keyword">int</span> length = connection.getContentLength();
    InputStream stream;
    <span class="hljs-keyword">if</span> (status &gt;= <span class="hljs-number">400</span>) {
      stream = connection.getErrorStream();
    } <span class="hljs-keyword">else</span> {
      stream = connection.getInputStream();
    }
    TypedInput responseBody = <span class="hljs-keyword">new</span> TypedInputStream(mimeType, length, stream);
    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Response</span><span class="hljs-params">(connection.getURL()</span>.<span class="hljs-title">toString</span><span class="hljs-params">()</span>, status, reason, headers, responseBody)</span>;
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TypedInputStream</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TypedInput</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mimeType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> length;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> InputStream stream;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">TypedInputStream</span><span class="hljs-params">(String mimeType, <span class="hljs-keyword">long</span> length, InputStream stream)</span> </span>{
      <span class="hljs-keyword">this</span>.mimeType = mimeType;
      <span class="hljs-keyword">this</span>.length = length;
      <span class="hljs-keyword">this</span>.stream = stream;
    }

    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">mimeType</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> mimeType;
    }

    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">length</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> length;
    }

    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> InputStream <span class="hljs-title">in</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{
      <span class="hljs-keyword">return</span> stream;
    }
  }
}
</code></pre>
<h3 id="参考">参考</h3>

<ul>
<li><p><a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank">理解RESTful架构</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank">RESTful API 设计指南</a></p>
</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../net/okhttp.html" class="navigation navigation-prev " aria-label="Previous page: OkHttp"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../net/volley.html" class="navigation navigation-next " aria-label="Next page: Volley"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-disqus/plugin.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"disqus":{"shortName":"malinkang"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
