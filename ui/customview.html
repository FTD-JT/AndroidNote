<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>自定义View | Android常用学习资源</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    
    <link rel="prev" href="../ui/layoutinflater.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="1.9" data-basepath=".." data-revision="1437125288874">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> UI</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" >
            
            <span><b>1.1.</b> Layouts</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" >
            
            <span><b>1.2.</b> Components</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.2.1" data-path="ui/textview.html">
            
                
                    <a href="../ui/textview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.1.</b>
                        
                         TextView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.2" data-path="ui/webview.html">
            
                
                    <a href="../ui/webview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.2.</b>
                        
                         WebView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.3" data-path="ui/recyclerview.html">
            
                
                    <a href="../ui/recyclerview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.3.</b>
                        
                         RecyclerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.4" data-path="ui/fragmenttabhost.html">
            
                
                    <a href="../ui/fragmenttabhost.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.4.</b>
                        
                         FragmentTabHost
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.5" data-path="ui/viewpager.html">
            
                
                    <a href="../ui/viewpager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.5.</b>
                        
                         ViewPager
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.3" >
            
            <span><b>1.3.</b> AdapterView</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.3.1" data-path="ui/listview.html">
            
                
                    <a href="../ui/listview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.1.</b>
                        
                         ListView
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.4" >
            
            <span><b>1.4.</b> Adapter</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="ui/actionbar.html">
            
                
                    <a href="../ui/actionbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         ActionBar
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="ui/toast.html">
            
                
                    <a href="../ui/toast.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         Toast
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="ui/notification.html">
            
                
                    <a href="../ui/notification.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         Notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="ui/layoutinflater.html">
            
                
                    <a href="../ui/layoutinflater.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         LayoutInflater
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1.9" data-path="ui/customview.html">
            
                
                    <a href="../ui/customview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         自定义View
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" >
            
            <span><b>1.10.</b> Resource</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.10.1" data-path="ui/drawable-resource.html">
            
                
                    <a href="../ui/drawable-resource.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.1.</b>
                        
                         DrawableResource
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Intent</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Activity</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="activity/Activity启动模式.html">
            
                
                    <a href="../activity/Activity启动模式.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Activity启动模式
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="activity/页面切换之间的数据传递.html">
            
                
                    <a href="../activity/页面切换之间的数据传递.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         数据传递
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" >
            
            <span><b>4.</b> Fragment</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="fragment/manager.html">
            
                
                    <a href="../fragment/manager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Fragment管理
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" >
            
            <span><b>5.</b> Service</span>
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="get_androidmanifest_info.html">
            
                
                    <a href="../get_androidmanifest_info.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         获取AndroidManifest.xml信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" >
            
            <span><b>7.</b> [多线程]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="7.1" data-path="multithread/handler.html">
            
                
                    <a href="../multithread/handler.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                         Handler
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="8" >
            
            <span><b>8.</b> [存储]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="8.1" data-path="data/sharedpreferences.html">
            
                
                    <a href="../data/sharedpreferences.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.</b>
                        
                         SharedPreferences
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="9" >
            
            <span><b>9.</b> [数据库]</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="9.1" data-path="database/SQLite.html">
            
                
                    <a href="../database/SQLite.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                         SQLite
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9.2" data-path="database/数据库操作.html">
            
                
                    <a href="../database/数据库操作.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                         数据库操作
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9.3" data-path="database/activeandroid.html">
            
                
                    <a href="../database/activeandroid.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                         ActiveAndroid
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="RxJava.html">
            
                
                    <a href="../RxJava.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         RxJava
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="MVVM.html">
            
                
                    <a href="../MVVM.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         MVVM
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="parse/gson.html">
            
                
                    <a href="../parse/gson.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         JSON解析
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" >
            
            <span><b>13.</b> 网络请求</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="13.1" data-path="net/httpurlconnection.html">
            
                
                    <a href="../net/httpurlconnection.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.1.</b>
                        
                         HttpURLConnection使用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.2" data-path="net/okhttp.html">
            
                
                    <a href="../net/okhttp.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.2.</b>
                        
                         OkHttp
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.3" data-path="net/retrofit.html">
            
                
                    <a href="../net/retrofit.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.3.</b>
                        
                         Retrofit
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13.4" data-path="net/volley.html">
            
                
                    <a href="../net/volley.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.4.</b>
                        
                         Volley
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="14" >
            
            <span><b>14.</b> 网络图片加载</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="14.1" data-path="net/android-universal-image-loader.html">
            
                
                    <a href="../net/android-universal-image-loader.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.1.</b>
                        
                         Android-Universal-Image-Loader
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14.2" data-path="net/picasso.html">
            
                
                    <a href="../net/picasso.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.2.</b>
                        
                         Picasso
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="net/downloadprovider.html">
            
                
                    <a href="../net/downloadprovider.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         DownloadProvider
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" >
            
            <span><b>16.</b> 注解</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="16.1" data-path="annotation/butterknife.html">
            
                
                    <a href="../annotation/butterknife.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.1.</b>
                        
                         ButterKnife
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16.2" data-path="annotation/androidannotations.html">
            
                
                    <a href="../annotation/androidannotations.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.2.</b>
                        
                         AndroidAnnotations
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="17" >
            
            <span><b>17.</b> 工具</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="17.1" >
            
            <span><b>17.1.</b> AndroidStudio</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="17.1.1" data-path="tools/android-studio/tips_and_tricks.html">
            
                
                    <a href="../tools/android-studio/tips_and_tricks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.1.1.</b>
                        
                         提示和技巧
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17.1.2" data-path="tools/android-studio/question.html">
            
                
                    <a href="../tools/android-studio/question.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.1.2.</b>
                        
                         常见问题
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="17.2" data-path="tools/android-resource-remover.html">
            
                
                    <a href="../tools/android-resource-remover.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.2.</b>
                        
                         android-resource-remover
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Android常用学习资源</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_33">
                    
                        <h2 id="">自定义控件</h2>
<h3 id="">目录</h3>
<ul>
<li><a href="#1.了解View的绘制流程">1.了解View的绘制流程</a><ul>
<li><a href="#1.1测量流程">1.1测量流程</a></li>
<li><a href="#1.2layout流程">1.2layout流程</a></li>
<li><a href="#1.3draw流程">1.3draw流程</a></li>
</ul>
</li>
<li><a href="#2.View事件传递">2.View事件传递</a></li>
<li><a href="#参考">参考</a></li>
</ul>
<h3 id="1.了解View的绘制流程">1.了解View的绘制流程</h3>

<p>View绘制流程</p>
<p><img src="images/view-flow.png" alt=""></p>
<h4 id="1.1测量流程">1.1测量流程</h4>

<p>测量流程由<code>View</code>的<code>measure</code>方法发起，从上到下有序的测量View，测量工作全部完成后，每个视图存储自己的尺寸大小和测量规格。</p>
<p>MeasureSpecs对象：包含测量要求和尺寸的信息，有三种模式：</p>
<ul>
<li>UNSPECIFIED 父View不对子View有任何约束，它可以达到所期望的任意尺寸，比如<code>ListView</code>和<code>ScrollView</code>。</li>
<li>EXACTLY 父View为子View指定一个确切的尺寸，而且无论子View期望多大，它都必须在该指定大小的边界内，对应的属性为<code>match_parent</code>或者具体值。</li>
<li>AT_MOST 父View为子View指定一个最大尺寸。对应的属性<code>wrap_content</code>。这种模式下，父控件无法确定子View的尺寸，只能子控件</li>
</ul>
<p>ViewGroup绘制流程</p>
<p><img src="images/measurechildflow.png" alt=""></p>
<p><code>measureChildren</code>方法</p>
<pre><code class="lang-java">    <span class="hljs-javadoc">/**
     * Ask all of the children of this view to measure themselves, taking into
     * account both the MeasureSpec requirements for this view and its padding.
     * We skip children that are in the GONE state The heavy lifting is done in
     * getChildMeasureSpec.
     *
     *<span class="hljs-javadoctag"> @param</span> widthMeasureSpec The width requirements for this view
     *<span class="hljs-javadoctag"> @param</span> heightMeasureSpec The height requirements for this view
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">measureChildren</span><span class="hljs-params">(<span class="hljs-keyword">int</span> widthMeasureSpec, <span class="hljs-keyword">int</span> heightMeasureSpec)</span> </span>{
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> size = mChildrenCount;
        <span class="hljs-keyword">final</span> View[] children = mChildren;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) {
            <span class="hljs-keyword">final</span> View child = children[i];
            <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) {
            <span class="hljs-comment">// GONE的View暂时不进行测量</span>
                measureChild(child, widthMeasureSpec, heightMeasureSpec);
            }
        }
    }
</code></pre>
<p><code>measureChild</code>方法</p>
<pre><code class="lang-java">   <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">measureChild</span><span class="hljs-params">(View child, <span class="hljs-keyword">int</span> parentWidthMeasureSpec,
            <span class="hljs-keyword">int</span> parentHeightMeasureSpec)</span> </span>{
            <span class="hljs-comment">//获取Child的LayoutParams</span>
        <span class="hljs-keyword">final</span> LayoutParams lp = child.getLayoutParams();
        <span class="hljs-comment">//// 获取 ChildView的widthMeasureSpec</span>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,
                mPaddingLeft + mPaddingRight, lp.width);
                <span class="hljs-comment">// 获取 ChildView的heightMeasureSpec</span>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,
                mPaddingTop + mPaddingBottom, lp.height);

        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);
    }
</code></pre>
<p><code>getChildMeasureSpec</code></p>
<pre><code class="lang-java">   <span class="hljs-javadoc">/**
     * Does the hard part of measureChildren: figuring out the MeasureSpec to
     * pass to a particular child. This method figures out the right MeasureSpec
     * for one dimension (height or width) of one child view.
     *
     * The goal is to combine information from our MeasureSpec with the
     * LayoutParams of the child to get the best possible results. For example,
     * if the this view knows its size (because its MeasureSpec has a mode of
     * EXACTLY), and the child has indicated in its LayoutParams that it wants
     * to be the same size as the parent, the parent should ask the child to
     * layout given an exact size.
     *
     *<span class="hljs-javadoctag"> @param</span> spec The requirements for this view
     *<span class="hljs-javadoctag"> @param</span> padding The padding of this view for the current dimension and
     *        margins, if applicable
     *<span class="hljs-javadoctag"> @param</span> childDimension How big the child wants to be in the current
     *        dimension
     *<span class="hljs-javadoctag"> @return</span> a MeasureSpec integer for the child
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getChildMeasureSpec</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spec, <span class="hljs-keyword">int</span> padding, <span class="hljs-keyword">int</span> childDimension)</span> </span>{
        <span class="hljs-keyword">int</span> specMode = MeasureSpec.getMode(spec);
        <span class="hljs-keyword">int</span> specSize = MeasureSpec.getSize(spec);

        <span class="hljs-keyword">int</span> size = Math.max(<span class="hljs-number">0</span>, specSize - padding);

        <span class="hljs-keyword">int</span> resultSize = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">int</span> resultMode = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">switch</span> (specMode) {
        <span class="hljs-comment">// Parent has imposed an exact size on us</span>
        <span class="hljs-keyword">case</span> MeasureSpec.EXACTLY:
            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) {
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.MATCH_PARENT)</span> </span>{
                <span class="hljs-comment">// Child wants to be our size. So be it.</span>
                resultSize = size;
                resultMode = MeasureSpec.EXACTLY;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.WRAP_CONTENT)</span> </span>{
                <span class="hljs-comment">// Child wants to determine its own size. It can't be</span>
                <span class="hljs-comment">// bigger than us.</span>
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            }
            <span class="hljs-keyword">break</span>;

        <span class="hljs-comment">// Parent has imposed a maximum size on us</span>
        <span class="hljs-keyword">case</span> MeasureSpec.AT_MOST:
            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// Child wants a specific size... so be it</span>
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.MATCH_PARENT)</span> </span>{
                <span class="hljs-comment">// Child wants to be our size, but our size is not fixed.</span>
                <span class="hljs-comment">// Constrain child to not be bigger than us.</span>
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.WRAP_CONTENT)</span> </span>{
                <span class="hljs-comment">// Child wants to determine its own size. It can't be</span>
                <span class="hljs-comment">// bigger than us.</span>
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            }
            <span class="hljs-keyword">break</span>;

        <span class="hljs-comment">// Parent asked to see how big we want to be</span>
        <span class="hljs-keyword">case</span> MeasureSpec.UNSPECIFIED:
            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// Child wants a specific size... let him have it</span>
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.MATCH_PARENT)</span> </span>{
                <span class="hljs-comment">// Child wants to be our size... find out how big it should</span>
                <span class="hljs-comment">// be</span>
                resultSize = <span class="hljs-number">0</span>;
                resultMode = MeasureSpec.UNSPECIFIED;
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(childDimension == LayoutParams.WRAP_CONTENT)</span> </span>{
                <span class="hljs-comment">// Child wants to determine its own size.... find out how</span>
                <span class="hljs-comment">// big it should be</span>
                resultSize = <span class="hljs-number">0</span>;
                resultMode = MeasureSpec.UNSPECIFIED;
            }
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);
    }
</code></pre>
<p><code>measure</code>方法在<code>View</code>类中，为final类型，不可被复写，但<code>measure</code>调用链最终会回调<code>onMeasure()</code>方法，因此自定义视图时，只需要复写<code>onMeasure</code>方法。</p>
<pre><code class="lang-java">    <span class="hljs-javadoc">/**
     * &lt;p&gt;
     * This is called to find out how big a view should be. The parent
     * supplies constraint information in the width and height parameters.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The actual measurement work of a view is performed in
     * {@link #onMeasure(int, int)}, called by this method. Therefore, only
     * {@link #onMeasure(int, int)} can and must be overridden by subclasses.
     * &lt;/p&gt;
     *
     *
     *<span class="hljs-javadoctag"> @param</span> widthMeasureSpec Horizontal space requirements as imposed by the
     *        parent
     *<span class="hljs-javadoctag"> @param</span> heightMeasureSpec Vertical space requirements as imposed by the
     *        parent
     *
     *<span class="hljs-javadoctag"> @see</span> #onMeasure(int, int)
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">measure</span><span class="hljs-params">(<span class="hljs-keyword">int</span> widthMeasureSpec, <span class="hljs-keyword">int</span> heightMeasureSpec)</span> </span>{
        <span class="hljs-keyword">boolean</span> optical = isLayoutModeOptical(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">if</span> (optical != isLayoutModeOptical(mParent)) {
            Insets insets = getOpticalInsets();
            <span class="hljs-keyword">int</span> oWidth  = insets.left + insets.right;
            <span class="hljs-keyword">int</span> oHeight = insets.top  + insets.bottom;
            widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);
            heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);
        }

        <span class="hljs-comment">// Suppress sign extension for the low bytes</span>
        <span class="hljs-keyword">long</span> key = (<span class="hljs-keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="hljs-number">32</span> | (<span class="hljs-keyword">long</span>) heightMeasureSpec &amp; <span class="hljs-number">0xffffffff</span>L;
        <span class="hljs-keyword">if</span> (mMeasureCache == <span class="hljs-keyword">null</span>) mMeasureCache = <span class="hljs-keyword">new</span> LongSparseLongArray(<span class="hljs-number">2</span>);

        <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||
                widthMeasureSpec != mOldWidthMeasureSpec ||
                heightMeasureSpec != mOldHeightMeasureSpec) {

            <span class="hljs-comment">// first clears the measured dimension flag</span>
            mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;

            resolveRtlPropertiesIfNeeded();

            <span class="hljs-keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="hljs-number">1</span> :
                    mMeasureCache.indexOfKey(key);
            <span class="hljs-keyword">if</span> (cacheIndex &lt; <span class="hljs-number">0</span> || sIgnoreMeasureCache) {
                <span class="hljs-comment">// measure ourselves, this should set the measured dimension flag back</span>
                onMeasure(widthMeasureSpec, heightMeasureSpec);
                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);
                <span class="hljs-comment">// Casting a long to int drops the high 32 bits, no mask needed</span>
                setMeasuredDimensionRaw((<span class="hljs-keyword">int</span>) (value &gt;&gt; <span class="hljs-number">32</span>), (<span class="hljs-keyword">int</span>) value);
                mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;
            }

            <span class="hljs-comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span>
            <span class="hljs-comment">// an exception to warn the developer</span>
            <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"onMeasure() did not set the"</span>
                        + <span class="hljs-string">" measured dimension by calling"</span>
                        + <span class="hljs-string">" setMeasuredDimension()"</span>);
            }

            mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;
        }

        mOldWidthMeasureSpec = widthMeasureSpec;
        mOldHeightMeasureSpec = heightMeasureSpec;

        mMeasureCache.put(key, ((<span class="hljs-keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="hljs-number">32</span> |
                (<span class="hljs-keyword">long</span>) mMeasuredHeight &amp; <span class="hljs-number">0xffffffff</span>L); <span class="hljs-comment">// suppress sign extension</span>
    }
</code></pre>
<p><code>onMeasure</code>方法。该方法就是我们自定义视图中实现测量逻辑的方法，该方法的参数是父View对子View的width和height的测量要求。</p>
<pre><code class="lang-java">    <span class="hljs-javadoc">/**
     * &lt;p&gt;
     * Measure the view and its content to determine the measured width and the
     * measured height. This method is invoked by {@link #measure(int, int)} and
     * should be overriden by subclasses to provide accurate and efficient
     * measurement of their contents.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you
     * &lt;em&gt;must&lt;/em&gt; call {@link #setMeasuredDimension(int, int)} to store the
     * measured width and height of this view. Failure to do so will trigger an
     * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by
     * {@link #measure(int, int)}. Calling the superclass'
     * {@link #onMeasure(int, int)} is a valid use.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The base class implementation of measure defaults to the background size,
     * unless a larger size is allowed by the MeasureSpec. Subclasses should
     * override {@link #onMeasure(int, int)} to provide better measurements of
     * their content.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * If this method is overridden, it is the subclass's responsibility to make
     * sure the measured height and width are at least the view's minimum height
     * and width ({@link #getSuggestedMinimumHeight()} and
     * {@link #getSuggestedMinimumWidth()}).
     * &lt;/p&gt;
     *
     *<span class="hljs-javadoctag"> @param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.
     *                         The requirements are encoded with
     *                         {@link android.view.View.MeasureSpec}.
     *<span class="hljs-javadoctag"> @param</span> heightMeasureSpec vertical space requirements as imposed by the parent.
     *                         The requirements are encoded with
     *                         {@link android.view.View.MeasureSpec}.
     *
     *<span class="hljs-javadoctag"> @see</span> #getMeasuredWidth()
     *<span class="hljs-javadoctag"> @see</span> #getMeasuredHeight()
     *<span class="hljs-javadoctag"> @see</span> #setMeasuredDimension(int, int)
     *<span class="hljs-javadoctag"> @see</span> #getSuggestedMinimumHeight()
     *<span class="hljs-javadoctag"> @see</span> #getSuggestedMinimumWidth()
     *<span class="hljs-javadoctag"> @see</span> android.view.View.MeasureSpec#getMode(int)
     *<span class="hljs-javadoctag"> @see</span> android.view.View.MeasureSpec#getSize(int)
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(<span class="hljs-keyword">int</span> widthMeasureSpec, <span class="hljs-keyword">int</span> heightMeasureSpec)</span> </span>{
        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),
                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));
    }
</code></pre>
<p><code>setMeasuredDimension</code>方法，将计算值传递给该方法，测量阶段即结束。</p>
<pre><code class="lang-java">    <span class="hljs-javadoc">/**
     * &lt;p&gt;This method must be called by {@link #onMeasure(int, int)} to store the
     * measured width and measured height. Failing to do so will trigger an
     * exception at measurement time.&lt;/p&gt;
     *
     *<span class="hljs-javadoctag"> @param</span> measuredWidth The measured width of this view.  May be a complex
     * bit mask as defined by {@link #MEASURED_SIZE_MASK} and
     * {@link #MEASURED_STATE_TOO_SMALL}.
     *<span class="hljs-javadoctag"> @param</span> measuredHeight The measured height of this view.  May be a complex
     * bit mask as defined by {@link #MEASURED_SIZE_MASK} and
     * {@link #MEASURED_STATE_TOO_SMALL}.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMeasuredDimension</span><span class="hljs-params">(<span class="hljs-keyword">int</span> measuredWidth, <span class="hljs-keyword">int</span> measuredHeight)</span> </span>{
        <span class="hljs-keyword">boolean</span> optical = isLayoutModeOptical(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">if</span> (optical != isLayoutModeOptical(mParent)) {
            Insets insets = getOpticalInsets();
            <span class="hljs-keyword">int</span> opticalWidth  = insets.left + insets.right;
            <span class="hljs-keyword">int</span> opticalHeight = insets.top  + insets.bottom;

            measuredWidth  += optical ? opticalWidth  : -opticalWidth;
            measuredHeight += optical ? opticalHeight : -opticalHeight;
        }
        setMeasuredDimensionRaw(measuredWidth, measuredHeight);
    }
</code></pre>
<h4 id="1.2layout流程">1.2layout流程</h4>

<p>子视图的具体位置都是相对于父视图而言的。View的<code>onLayout</code>方法为空实现，而<code>ViewGroup</code>的<code>onLayout</code>为<code>abstract</code>。</p>
<p>在layout过程中，子视图会调用<code>getMeasuredWidth()</code>和<code>getMeasuredHeight()</code>方法获取到 <code>measure</code> 过程得到的 <code>mMeasuredWidth</code> 和 <code>mMeasuredHeight</code>，作为自己的 width 和 height。然后调用每一个子视图的<code>layout(l, t, r, b)</code>函数，来确定每个子视图在父视图中的位置。</p>
<p>LinearLayout的<code>onLayout</code>方法。</p>
<pre><code class="lang-java">
   <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onLayout</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> changed, <span class="hljs-keyword">int</span> l, <span class="hljs-keyword">int</span> t, <span class="hljs-keyword">int</span> r, <span class="hljs-keyword">int</span> b)</span> </span>{
        <span class="hljs-keyword">if</span> (mOrientation == VERTICAL) {
            layoutVertical(l, t, r, b);
        } <span class="hljs-keyword">else</span> {
            layoutHorizontal(l, t, r, b);
        }
    }

    <span class="hljs-javadoc">/**
     * Position the children during a layout pass if the orientation of this
     * LinearLayout is set to {@link #VERTICAL}.
     *
     *<span class="hljs-javadoctag"> @see</span> #getOrientation()
     *<span class="hljs-javadoctag"> @see</span> #setOrientation(int)
     *<span class="hljs-javadoctag"> @see</span> #onLayout(boolean, int, int, int, int)
     *<span class="hljs-javadoctag"> @param</span> left
     *<span class="hljs-javadoctag"> @param</span> top
     *<span class="hljs-javadoctag"> @param</span> right
     *<span class="hljs-javadoctag"> @param</span> bottom
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">layoutVertical</span><span class="hljs-params">(<span class="hljs-keyword">int</span> left, <span class="hljs-keyword">int</span> top, <span class="hljs-keyword">int</span> right, <span class="hljs-keyword">int</span> bottom)</span> </span>{
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> paddingLeft = mPaddingLeft;

        <span class="hljs-keyword">int</span> childTop;
        <span class="hljs-keyword">int</span> childLeft;

        <span class="hljs-comment">// Where right end of child should go</span>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> width = right - left;
        <span class="hljs-keyword">int</span> childRight = width - mPaddingRight;

        <span class="hljs-comment">// Space available for child</span>
        <span class="hljs-keyword">int</span> childSpace = width - paddingLeft - mPaddingRight;

        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = getVirtualChildCount();

        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> majorGravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> minorGravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;

        <span class="hljs-keyword">switch</span> (majorGravity) {
           <span class="hljs-keyword">case</span> Gravity.BOTTOM:
               <span class="hljs-comment">// mTotalLength contains the padding already</span>
               childTop = mPaddingTop + bottom - top - mTotalLength;
               <span class="hljs-keyword">break</span>;

               <span class="hljs-comment">// mTotalLength contains the padding already</span>
           <span class="hljs-keyword">case</span> Gravity.CENTER_VERTICAL:
               childTop = mPaddingTop + (bottom - top - mTotalLength) / <span class="hljs-number">2</span>;
               <span class="hljs-keyword">break</span>;

           <span class="hljs-keyword">case</span> Gravity.TOP:
           <span class="hljs-keyword">default</span>:
               childTop = mPaddingTop;
               <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-keyword">final</span> View child = getVirtualChildAt(i);
            <span class="hljs-keyword">if</span> (child == <span class="hljs-keyword">null</span>) {
                childTop += measureNullChild(i);
            } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(child.getVisibility()</span> !</span>= GONE) {
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> childWidth = child.getMeasuredWidth();
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> childHeight = child.getMeasuredHeight();

                <span class="hljs-keyword">final</span> LinearLayout.LayoutParams lp =
                        (LinearLayout.LayoutParams) child.getLayoutParams();

                <span class="hljs-keyword">int</span> gravity = lp.gravity;
                <span class="hljs-keyword">if</span> (gravity &lt; <span class="hljs-number">0</span>) {
                    gravity = minorGravity;
                }
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> layoutDirection = getLayoutDirection();
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);
                <span class="hljs-keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) {
                    <span class="hljs-keyword">case</span> Gravity.CENTER_HORIZONTAL:
                        childLeft = paddingLeft + ((childSpace - childWidth) / <span class="hljs-number">2</span>)
                                + lp.leftMargin - lp.rightMargin;
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Gravity.RIGHT:
                        childLeft = childRight - childWidth - lp.rightMargin;
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Gravity.LEFT:
                    <span class="hljs-keyword">default</span>:
                        childLeft = paddingLeft + lp.leftMargin;
                        <span class="hljs-keyword">break</span>;
                }

                <span class="hljs-keyword">if</span> (hasDividerBeforeChildAt(i)) {
                    childTop += mDividerHeight;
                }

                childTop += lp.topMargin;
                setChildFrame(child, childLeft, childTop + getLocationOffset(child),
                        childWidth, childHeight);
                childTop += childHeight + lp.bottomMargin + getNextLocationOffset(child);

                i += getChildrenSkipCount(child, i);
            }
        }
    }
</code></pre>
<h4 id="1.3draw流程">1.3draw流程</h4>

<ul>
<li>View.draw(Canvas canvas)： 由于 ViewGroup 并没有复写此方法，因此，所有的视图最终都是调用 View 的 draw 方法进行绘制的。在自定义的视图中，也不应该复写该方法，而是复写 onDraw(Canvas) 方法进行绘制，如果自定义的视图确实要复写该方法，那么请先调用 super.draw(canvas)完成系统的绘制，然后再进行自定义的绘制。</li>
<li>View.onDraw()：View的onDraw（Canvas）默认是空实现，自定义绘制过程需要复写的方法，绘制自身的内容。</li>
<li>dispatchDraw() 发起对子视图的绘制。View中默认是空实现，ViewGroup 复写了dispatchDraw()来对其子视图进行绘制。该方法我们不用去管，自定义的 ViewGroup 不应该对dispatchDraw()进行复写。</li>
</ul>
<p>绘制View流程</p>
<p><img src="images/draw_method_flow.png" alt=""></p>
<pre><code class="lang-java">    <span class="hljs-javadoc">/**
     * Manually render this view (and all of its children) to the given Canvas.
     * The view must have already done a full layout before this function is
     * called.  When implementing a view, implement
     * {@link #onDraw(android.graphics.Canvas)} instead of overriding this method.
     * If you do need to override this method, call the superclass version.
     *
     *<span class="hljs-javadoctag"> @param</span> canvas The Canvas to which the View is rendered.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">draw</span><span class="hljs-params">(Canvas canvas)</span> </span>{
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> privateFlags = mPrivateFlags;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;
                (mAttachInfo == <span class="hljs-keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);
        mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;

        <span class="hljs-comment">/*
         * Draw traversal performs several drawing steps which must be executed
         * in the appropriate order:
         *
         *      1. Draw the background
         *      2. If necessary, save the canvas' layers to prepare for fading
         *      3. Draw view's content
         *      4. Draw children
         *      5. If necessary, draw the fading edges and restore layers
         *      6. Draw decorations (scrollbars for instance)
         */</span>

        <span class="hljs-comment">// Step 1, draw the background, if needed</span>
        <span class="hljs-keyword">int</span> saveCount;

        <span class="hljs-keyword">if</span> (!dirtyOpaque) {
            drawBackground(canvas);
        }

        <span class="hljs-comment">// skip step 2 &amp; 5 if possible (common case)</span>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> viewFlags = mViewFlags;
        <span class="hljs-keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="hljs-number">0</span>;
        <span class="hljs-keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) {
            <span class="hljs-comment">// Step 3, draw the content</span>
            <span class="hljs-keyword">if</span> (!dirtyOpaque) onDraw(canvas);

            <span class="hljs-comment">// Step 4, draw the children</span>
            dispatchDraw(canvas);

            <span class="hljs-comment">// Step 6, draw decorations (scrollbars)</span>
            onDrawScrollBars(canvas);

            <span class="hljs-keyword">if</span> (mOverlay != <span class="hljs-keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) {
                mOverlay.getOverlayView().dispatchDraw(canvas);
            }

            <span class="hljs-comment">// we're done...</span>
            <span class="hljs-keyword">return</span>;
        }
</code></pre>
<p>dispatchDraw</p>
<pre><code class="lang-java">   <span class="hljs-javadoc">/**
     * {@inheritDoc}
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dispatchDraw</span><span class="hljs-params">(Canvas canvas)</span> </span>{
        <span class="hljs-keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> childrenCount = mChildrenCount;
        <span class="hljs-keyword">final</span> View[] children = mChildren;
        <span class="hljs-keyword">int</span> flags = mGroupFlags;

        <span class="hljs-keyword">if</span> ((flags &amp; FLAG_RUN_ANIMATION) != <span class="hljs-number">0</span> &amp;&amp; canAnimate()) {
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> cache = (mGroupFlags &amp; FLAG_ANIMATION_CACHE) == FLAG_ANIMATION_CACHE;

            <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> buildCache = !isHardwareAccelerated();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; childrenCount; i++) {
                <span class="hljs-keyword">final</span> View child = children[i];
                <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) {
                    <span class="hljs-keyword">final</span> LayoutParams params = child.getLayoutParams();
                    attachLayoutAnimationParameters(child, params, i, childrenCount);
                    bindLayoutAnimation(child);
                    <span class="hljs-keyword">if</span> (cache) {
                        child.setDrawingCacheEnabled(<span class="hljs-keyword">true</span>);
                        <span class="hljs-keyword">if</span> (buildCache) {
                            child.buildDrawingCache(<span class="hljs-keyword">true</span>);
                        }
                    }
                }
            }

            <span class="hljs-keyword">final</span> LayoutAnimationController controller = mLayoutAnimationController;
            <span class="hljs-keyword">if</span> (controller.willOverlap()) {
                mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;
            }

            controller.start();

            mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;
            mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;

            <span class="hljs-keyword">if</span> (cache) {
                mGroupFlags |= FLAG_CHILDREN_DRAWN_WITH_CACHE;
            }

            <span class="hljs-keyword">if</span> (mAnimationListener != <span class="hljs-keyword">null</span>) {
                mAnimationListener.onAnimationStart(controller.getAnimation());
            }
        }

        <span class="hljs-keyword">int</span> clipSaveCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;
        <span class="hljs-keyword">if</span> (clipToPadding) {
            clipSaveCount = canvas.save();
            canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,
                    mScrollX + mRight - mLeft - mPaddingRight,
                    mScrollY + mBottom - mTop - mPaddingBottom);
        }

        <span class="hljs-comment">// We will draw our child's animation, let's reset the flag</span>
        mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;
        mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;

        <span class="hljs-keyword">boolean</span> more = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> drawingTime = getDrawingTime();

        <span class="hljs-keyword">if</span> (usingRenderNodeProperties) canvas.insertReorderBarrier();
        <span class="hljs-comment">// Only use the preordered list if not HW accelerated, since the HW pipeline will do the</span>
        <span class="hljs-comment">// draw reordering internally</span>
        <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties
                ? <span class="hljs-keyword">null</span> : buildOrderedChildList();
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> customOrder = preorderedList == <span class="hljs-keyword">null</span>
                &amp;&amp; isChildrenDrawingOrderEnabled();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; childrenCount; i++) {
            <span class="hljs-keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;
            <span class="hljs-keyword">final</span> View child = (preorderedList == <span class="hljs-keyword">null</span>)
                    ? children[childIndex] : preorderedList.get(childIndex);
            <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="hljs-keyword">null</span>) {
                more |= drawChild(canvas, child, drawingTime);
            }
        }
        <span class="hljs-keyword">if</span> (preorderedList != <span class="hljs-keyword">null</span>) preorderedList.clear();

        <span class="hljs-comment">// Draw any disappearing views that have animations</span>
        <span class="hljs-keyword">if</span> (mDisappearingChildren != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> disappearingCount = disappearingChildren.size() - <span class="hljs-number">1</span>;
            <span class="hljs-comment">// Go backwards -- we may delete as animations finish</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = disappearingCount; i &gt;= <span class="hljs-number">0</span>; i--) {
                <span class="hljs-keyword">final</span> View child = disappearingChildren.get(i);
                more |= drawChild(canvas, child, drawingTime);
            }
        }
        <span class="hljs-keyword">if</span> (usingRenderNodeProperties) canvas.insertInorderBarrier();

        <span class="hljs-keyword">if</span> (debugDraw()) {
            onDebugDraw(canvas);
        }

        <span class="hljs-keyword">if</span> (clipToPadding) {
            canvas.restoreToCount(clipSaveCount);
        }

        <span class="hljs-comment">// mGroupFlags might have been updated by drawChild()</span>
        flags = mGroupFlags;

        <span class="hljs-keyword">if</span> ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) {
            invalidate(<span class="hljs-keyword">true</span>);
        }

        <span class="hljs-keyword">if</span> ((flags &amp; FLAG_ANIMATION_DONE) == <span class="hljs-number">0</span> &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == <span class="hljs-number">0</span> &amp;&amp;
                mLayoutAnimationController.isDone() &amp;&amp; !more) {
            <span class="hljs-comment">// We want to erase the drawing cache and notify the listener after the</span>
            <span class="hljs-comment">// next frame is drawn because one extra invalidate() is caused by</span>
            <span class="hljs-comment">// drawChild() after the animation is over</span>
            mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;
            <span class="hljs-keyword">final</span> Runnable end = <span class="hljs-keyword">new</span> Runnable() {
               <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                   notifyAnimationListener();
               }
            };
            post(end);
        }
    }


    <span class="hljs-javadoc">/**
     * Draw one child of this View Group. This method is responsible for getting
     * the canvas in the right state. This includes clipping, translating so
     * that the child's scrolled origin is at 0, 0, and applying any animation
     * transformations.
     *
     *<span class="hljs-javadoctag"> @param</span> canvas The canvas on which to draw the child
     *<span class="hljs-javadoctag"> @param</span> child Who to draw
     *<span class="hljs-javadoctag"> @param</span> drawingTime The time at which draw is occurring
     *<span class="hljs-javadoctag"> @return</span> True if an invalidate() was issued
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">drawChild</span><span class="hljs-params">(Canvas canvas, View child, <span class="hljs-keyword">long</span> drawingTime)</span> </span>{
        <span class="hljs-keyword">return</span> child.draw(canvas, <span class="hljs-keyword">this</span>, drawingTime);
    }
</code></pre>
<h3 id="2.View事件传递">2.View事件传递</h3>

<h3 id="参考">参考</h3>

<ul>
<li><a href="http://wugengxin.cn/download/pdf/android/PRE_andevcon_mastering-the-android-touch-system.pdf" target="_blank">Mastering the Android Touch System</a></li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../ui/layoutinflater.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: LayoutInflater"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-disqus/plugin.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"disqus":{"shortName":"malinkang"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
